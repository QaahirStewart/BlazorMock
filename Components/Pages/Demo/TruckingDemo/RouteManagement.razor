@page "/demo/trucking/routes"
@using BlazorMock.Data
@using BlazorMock.Models
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<AppDbContext> DbFactory
@inject NavigationManager Nav
@rendermode InteractiveServer

<PageTitle>Route Management - Trucking Demo</PageTitle>

<div class="min-h-screen py-8">
    <div class="w-full mx-auto px-4 max-w-6xl">
        <div class="mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Routes</h1>
            <p class="text-sm text-gray-600 mt-1">Manage routes and shipment schedules</p>
        </div>

        <!-- Back to Demo Link -->
        <div class="mb-6">
            <a href="/demo/trucking-schedule" class="text-sm text-blue-600 hover:text-blue-700">‚Üê Back to Schedule Demo</a>
        </div>

        <!-- Add Route Section -->
        <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-3">Add New Route</h2>
        </div>

        <div class="bg-white border border-gray-200 rounded-lg p-4 sm:p-6 mb-6">
            <EditForm Model="newRoute" OnValidSubmit="AddRouteAsync">
                <DataAnnotationsValidator />
                <ValidationSummary class="mb-3 text-xs sm:text-sm text-red-600" />

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Route #</label>
                        <InputText class="w-full rounded border border-gray-300 p-2 text-sm"
                            @bind-Value="newRoute.RouteNumber" />
                        <ValidationMessage For="() => newRoute.RouteNumber" class="text-xs text-red-600 mt-1" />
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Type</label>
                        <InputSelect class="w-full rounded border border-gray-300 p-2 text-sm" @bind-Value="newRoute.Type">
                            @foreach (RouteType t in Enum.GetValues(typeof(RouteType)))
                            {
                                <option value="@t">@t</option>
                            }
                        </InputSelect>
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Origin</label>
                        <InputText class="w-full rounded border border-gray-300 p-2 text-sm" @bind-Value="newRoute.Origin" />
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Destination</label>
                        <InputText class="w-full rounded border border-gray-300 p-2 text-sm"
                            @bind-Value="newRoute.Destination" />
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Distance (mi)</label>
                        <InputNumber class="w-full rounded border border-gray-300 p-2 text-sm"
                            @bind-Value="newRoute.DistanceMiles" />
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Revenue ($)</label>
                        <InputNumber class="w-full rounded border border-gray-300 p-2 text-sm"
                            @bind-Value="newRoute.Revenue" />
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Driver</label>
                        <InputSelect class="w-full rounded border border-gray-300 p-2 text-sm" @bind-Value="newRoute.DriverId">
                            <option value="">-- select --</option>
                            @foreach (var d in drivers)
                            {
                                <option value="@d.Id">@d.Name (@d.LicenseLevel)</option>
                            }
                        </InputSelect>
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Truck</label>
                        <InputSelect class="w-full rounded border border-gray-300 p-2 text-sm" @bind-Value="newRoute.TruckId">
                            <option value="">-- select --</option>
                            @foreach (var t in trucks)
                            {
                                <option value="@t.Id">@t.GetDisplayName()</option>
                            }
                        </InputSelect>
                    </div>
                </div>

                <div class="flex flex-wrap items-center gap-2">
                    <button type="submit"
                        class="px-4 py-2 text-sm font-medium bg-blue-600 hover:bg-blue-700 text-white rounded transition-colors">Add
                        Route</button>
                    <button type="button"
                        class="px-4 py-2 text-sm font-medium bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 rounded transition-colors"
                        @onclick="ResetNewRoute">Reset</button>
                </div>
            </EditForm>
        </div>

        <!-- Current Routes Section -->
        <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-3">Current Routes</h2>
        </div>

        <div class="bg-white border border-gray-200 rounded-lg p-4">
            @if (routes is null)
            {
                <div class="p-3 text-sm">Loading...</div>
            }
            else if (!routes.Any())
            {
                <div class="p-3 text-sm">No routes yet.</div>
            }
            else
            {
                <!-- Mobile: Card list -->
                <div class="space-y-3 md:hidden">
                    @foreach (var r in routes)
                    {
                        var isEditing = editRoute?.Id == r.Id;
                        <div class="rounded border-2 border-gray-200 hover:border-blue-400 transition-all duration-200 bg-white p-4">
                            @if (isEditing)
                            {
                                <div class="space-y-2 mb-3">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Route #</label>
                                        <InputText class="w-full rounded border border-gray-300 p-1.5 text-sm"
                                            @bind-Value="editRoute!.RouteNumber" />
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Type</label>
                                        <InputSelect class="w-full rounded border border-gray-300 p-1.5 text-sm"
                                            @bind-Value="editRoute!.Type">
                                            @foreach (RouteType t in Enum.GetValues(typeof(RouteType)))
                                            {
                                                <option value="@t">@t</option>
                                            }
                                        </InputSelect>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Origin</label>
                                        <InputText class="w-full rounded border border-gray-300 p-1.5 text-sm"
                                            @bind-Value="editRoute!.Origin" />
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Destination</label>
                                        <InputText class="w-full rounded border border-gray-300 p-1.5 text-sm"
                                            @bind-Value="editRoute!.Destination" />
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Distance (mi)</label>
                                        <InputNumber class="w-full rounded border border-gray-300 p-1.5 text-sm"
                                            @bind-Value="editRoute!.DistanceMiles" />
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Driver</label>
                                        <InputSelect class="w-full rounded border border-gray-300 p-1.5 text-sm"
                                            @bind-Value="editRoute!.DriverId">
                                            @foreach (var d in drivers)
                                            {
                                                <option value="@d.Id">@d.Name (@d.LicenseLevel)</option>
                                            }
                                        </InputSelect>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-700 mb-1">Truck</label>
                                        <InputSelect class="w-full rounded border border-gray-300 p-1.5 text-sm"
                                            @bind-Value="editRoute!.TruckId">
                                            @foreach (var t in trucks)
                                            {
                                                <option value="@t.Id">@t.GetDisplayName()</option>
                                            }
                                        </InputSelect>
                                    </div>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <button class="px-3 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm"
                                        @onclick="() => SaveEditAsync(r.Id)">Save</button>
                                    <button class="px-3 py-2 rounded border border-gray-300 hover:bg-gray-50 text-sm"
                                        @onclick="CancelEdit">Cancel</button>
                                </div>
                            }
                            else
                            {
                                <div class="mb-3">
                                    <div class="text-base font-semibold text-gray-900">@r.RouteNumber</div>
                                    <div class="text-sm text-gray-600">@r.GetRouteSummary()</div>
                                    <div class="text-sm text-gray-600">Driver: @r.Driver?.Name</div>
                                    <div class="text-sm text-gray-600">Truck: @r.Truck?.GetDisplayName()</div>
                                    <div class="text-sm text-gray-600">Revenue: @r.Revenue.ToString("C")</div>
                                    <span class="@GetStatusBadgeClass(r.Status) mt-1">@r.Status</span>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <button class="px-3 py-2 rounded border border-gray-300 hover:bg-gray-50 text-sm"
                                        @onclick="() => BeginEdit(r)">Edit</button>
                                    <button class="px-3 py-2 rounded border border-gray-300 hover:bg-gray-50 text-sm"
                                        @onclick="() => DeleteRouteAsync(r.Id)">Delete</button>
                                </div>
                            }
                        </div>
                    }
                </div>

                <!-- Desktop/Tablet: Table -->
                <div class="overflow-x-auto hidden md:block">
                    <table class="min-w-full border border-gray-200 rounded overflow-hidden">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left p-2 text-sm font-medium text-gray-700 border-b">Route #</th>
                                <th class="text-left p-2 text-sm font-medium text-gray-700 border-b">Summary</th>
                                <th class="text-left p-2 text-sm font-medium text-gray-700 border-b">Driver</th>
                                <th class="text-left p-2 text-sm font-medium text-gray-700 border-b">Truck</th>
                                <th class="text-left p-2 text-sm font-medium text-gray-700 border-b">Revenue</th>
                                <th class="text-left p-2 text-sm font-medium text-gray-700 border-b">Status</th>
                                <th class="text-left p-2 text-sm font-medium text-gray-700 border-b">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var r in routes)
                            {
                                var isEditing = editRoute?.Id == r.Id;
                                <tr class="odd:bg-white even:bg-gray-50 align-top">
                                    <td class="p-2 border-b text-sm">
                                        @if (isEditing)
                                        {
                                            <InputText class="w-full rounded border border-gray-300 p-1.5"
                                                @bind-Value="editRoute!.RouteNumber" />
                                        }
                                        else
                                        {
                                            @r.RouteNumber
                                        }
                                    </td>
                                    <td class="p-2 border-b text-sm">
                                        @if (isEditing)
                                        {
                                            <div class="grid grid-cols-1 gap-1">
                                                <div>
                                                    <label class="block text-xs text-gray-600">Type</label>
                                                    <InputSelect class="w-full rounded border border-gray-300 p-1.5"
                                                        @bind-Value="editRoute!.Type">
                                                        @foreach (RouteType t in Enum.GetValues(typeof(RouteType)))
                                                        {
                                                            <option value="@t">@t</option>
                                                        }
                                                    </InputSelect>
                                                </div>
                                                <div class="grid grid-cols-2 gap-2">
                                                    <div>
                                                        <label class="block text-xs text-gray-600">Origin</label>
                                                        <InputText class="w-full rounded border border-gray-300 p-1.5"
                                                            @bind-Value="editRoute!.Origin" />
                                                    </div>
                                                    <div>
                                                        <label class="block text-xs text-gray-600">Destination</label>
                                                        <InputText class="w-full rounded border border-gray-300 p-1.5"
                                                            @bind-Value="editRoute!.Destination" />
                                                    </div>
                                                </div>
                                                <div>
                                                    <label class="block text-xs text-gray-600">Distance (mi)</label>
                                                    <InputNumber class="w-28 rounded border border-gray-300 p-1.5"
                                                        @bind-Value="editRoute!.DistanceMiles" />
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            @r.GetRouteSummary()
                                        }
                                    </td>
                                    <td class="p-2 border-b text-sm">
                                        @if (isEditing)
                                        {
                                            <InputSelect class="w-full rounded border border-gray-300 p-1.5"
                                                @bind-Value="editRoute!.DriverId">
                                                @foreach (var d in drivers)
                                                {
                                                    <option value="@d.Id">@d.Name (@d.LicenseLevel)</option>
                                                }
                                            </InputSelect>
                                        }
                                        else
                                        {
                                            @r.Driver?.Name
                                        }
                                    </td>
                                    <td class="p-2 border-b text-sm">
                                        @if (isEditing)
                                        {
                                            <InputSelect class="w-full rounded border border-gray-300 p-1.5"
                                                @bind-Value="editRoute!.TruckId">
                                                @foreach (var t in trucks)
                                                {
                                                    <option value="@t.Id">@t.GetDisplayName()</option>
                                                }
                                            </InputSelect>
                                        }
                                        else
                                        {
                                            @r.Truck?.GetDisplayName()
                                        }
                                    </td>
                                    <td class="p-2 border-b text-sm">
                                        @r.Revenue.ToString("C")
                                    </td>
                                    <td class="p-2 border-b text-sm">
                                        <span class="@GetStatusBadgeClass(r.Status)">@r.Status</span>
                                    </td>
                                    <td class="p-2 border-b whitespace-nowrap">
                                        @if (isEditing)
                                        {
                                            <button class="px-3 py-1 text-xs rounded bg-blue-600 text-white mr-1 hover:bg-blue-700"
                                                @onclick="() => SaveEditAsync(r.Id)">Save</button>
                                            <button class="px-3 py-1 text-xs rounded border border-gray-300 hover:bg-gray-50" @onclick="CancelEdit">Cancel</button>
                                        }
                                        else
                                        {
                                            <button class="px-3 py-1 text-xs rounded border border-gray-300 mr-1 hover:bg-gray-50" @onclick="() => BeginEdit(r)">Edit</button>
                                            <button class="px-3 py-1 text-xs rounded border border-gray-300 hover:bg-gray-50"
                                                @onclick="() => DeleteRouteAsync(r.Id)">Delete</button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private List<Route> routes = new();
    private List<Driver> drivers = new();
    private List<Truck> trucks = new();
    private Route newRoute = new()
        {
            Type = RouteType.Standard,
            ScheduledStartDate = DateTime.Now,
            Status = RouteStatus.Scheduled
        };
    private Route? editRoute;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        using var db = await DbFactory.CreateDbContextAsync();
        routes = await db.Routes.Include(r => r.Driver).Include(r => r.Truck).OrderBy(r => r.RouteNumber).ToListAsync();
        drivers = await db.Drivers.OrderBy(d => d.Name).ToListAsync();
        trucks = await db.Trucks.OrderBy(t => t.TruckNumber).ToListAsync();
    }

    private async Task AddRouteAsync()
    {
        using var db = await DbFactory.CreateDbContextAsync();
        db.Routes.Add(newRoute);
        await db.SaveChangesAsync();
        newRoute = new() { Type = RouteType.Standard, ScheduledStartDate = DateTime.Now, Status = RouteStatus.Scheduled };
        await LoadAsync();
    }

    private void ResetNewRoute()
    {
        newRoute = new() { Type = RouteType.Standard, ScheduledStartDate = DateTime.Now, Status = RouteStatus.Scheduled };
    }

    private async Task DeleteRouteAsync(int id)
    {
        using var db = await DbFactory.CreateDbContextAsync();
        var entity = await db.Routes.FindAsync(id);
        if (entity is not null)
        {
            db.Remove(entity);
            await db.SaveChangesAsync();
            await LoadAsync();
        }
    }

    private void BeginEdit(Route r)
    {
        editRoute = new Route
            {
                Id = r.Id,
                RouteNumber = r.RouteNumber,
                Type = r.Type,
                Origin = r.Origin,
                Destination = r.Destination,
                DistanceMiles = r.DistanceMiles,
                DriverId = r.DriverId,
                TruckId = r.TruckId,
                ScheduledStartDate = r.ScheduledStartDate,
                Status = r.Status,
                EstimatedEndDate = r.EstimatedEndDate,
                ActualStartDate = r.ActualStartDate,
                ActualEndDate = r.ActualEndDate,
                EstimatedFuelCost = r.EstimatedFuelCost,
                DriverPay = r.DriverPay,
                Revenue = r.Revenue,
                Notes = r.Notes
            };
    }

    private void CancelEdit() => editRoute = null;

    private async Task SaveEditAsync(int id)
    {
        if (editRoute is null) return;
        using var db = await DbFactory.CreateDbContextAsync();
        var entity = await db.Routes.FindAsync(id);
        if (entity is null) return;

        entity.RouteNumber = editRoute.RouteNumber;
        entity.Type = editRoute.Type;
        entity.Origin = editRoute.Origin;
        entity.Destination = editRoute.Destination;
        entity.DistanceMiles = editRoute.DistanceMiles;
        entity.DriverId = editRoute.DriverId;
        entity.TruckId = editRoute.TruckId;

        await db.SaveChangesAsync();
        editRoute = null;
        await LoadAsync();
    }

    private string GetStatusBadgeClass(RouteStatus status) => status switch
    {
        RouteStatus.Scheduled => "inline-flex px-2 py-0.5 text-xs font-medium bg-gray-100 text-gray-700 rounded",
        RouteStatus.InProgress => "inline-flex px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-700 rounded",
        RouteStatus.Completed => "inline-flex px-2 py-0.5 text-xs font-medium bg-gray-900 text-white rounded",
        RouteStatus.Cancelled => "inline-flex px-2 py-0.5 text-xs font-medium bg-gray-200 text-gray-600 rounded",
        RouteStatus.Delayed => "inline-flex px-2 py-0.5 text-xs font-medium bg-gray-700 text-white rounded",
        _ => "inline-flex px-2 py-0.5 text-xs font-medium bg-gray-100 text-gray-600 rounded"
    };
}
