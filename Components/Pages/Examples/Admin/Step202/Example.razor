@page "/admin-examples/step202"
@rendermode InteractiveServer
@inject ILearningProgressService ProgressService
@inject IJSRuntime JS
@implements IDisposable

<PageTitle>Admin Step 3: Fake Login & Auth State - Example</PageTitle>

<div class="min-h-screen py-8 rounded-4xl bg-gray-50">
    <div class="w-full mx-auto px-4 max-w-5xl">
        <!-- Back link -->
        <a href="/admin-guide"
            class="inline-flex items-center gap-2 text-sm sm:text-base text-blue-600 hover:text-blue-700 mb-4">
            <span>‚Üê</span> Back to Admin Guide
        </a>

        <!-- Title -->
        <h1 class="text-4xl font-bold text-gray-900 mb-4">
            üîê Step 3: Fake Login & Auth State
        </h1>

        <!-- Description -->
        <p class="text-xl text-gray-600 mb-8">
            Build a login page with hardcoded credentials and manage authentication state to control what users can see and do.
        </p>

        <!-- What You'll Learn -->
        <div class="bg-gradient-to-r from-purple-100 to-indigo-100 rounded-2xl p-5 sm:p-6 mb-6">
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-4">What You'll Learn</h2>

            <p class="text-gray-700 mb-4 text-sm sm:text-base">
                Authentication is essential for admin panels. This step teaches you how to create a simple login form,
                validate credentials against hardcoded users, and track authentication state to show different content
                based on whether someone is logged in.
            </p>

            <ul class="list-disc ml-6 text-sm sm:text-base text-gray-700 space-y-2 mb-4">
                <li>Create a login form with email and password inputs</li>
                <li>Use @@bind to capture user input in real-time</li>
                <li>Validate credentials against hardcoded demo users</li>
                <li>Track authentication state with a boolean flag</li>
                <li>Conditionally render UI based on authentication status</li>
            </ul>

            <div class="mt-2 pt-3 border-t border-purple-200">
                <p class="text-xs sm:text-sm text-gray-700 mb-2">
                    <strong>üí° Key Concepts:</strong> @@bind directive, Conditional rendering, State management, Form validation
                </p>
            </div>
        </div>

        <!-- Live Demo -->
        <div class="bg-black/3 rounded-2xl p-6 mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">üé¨ Live Demo</h2>
            
            @if (!isAuthenticated)
            {
                <div class="max-w-md mx-auto">
                    <div class="bg-white rounded-2xl border-2 border-gray-200 p-6">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 bg-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-3xl text-white">üõ°Ô∏è</span>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-900 mb-2">Login</h3>
                            <p class="text-gray-600">Enter your credentials</p>
                        </div>

                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded text-red-700 text-sm">
                                @errorMessage
                            </div>
                        }

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input type="email" @bind="email" @bind:event="oninput"
                                    class="w-full rounded border border-gray-300 p-3"
                                    placeholder="admin@example.com" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input type="password" @bind="password" @bind:event="oninput"
                                    @onkeydown="@(e => { if (e.Key == "Enter") HandleLogin(); })"
                                    class="w-full rounded border border-gray-300 p-3"
                                    placeholder="admin123" />
                            </div>
                        </div>

                        <button @onclick="HandleLogin"
                            class="w-full mt-6 bg-purple-600 text-white font-medium py-3 rounded hover:bg-purple-700 transition-colors">
                            Sign In
                        </button>

                        <div class="mt-4 p-3 bg-gray-50 rounded text-xs text-gray-600">
                            <strong>Demo credentials:</strong> admin@example.com / admin123
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="max-w-md mx-auto bg-white rounded-2xl border-2 border-green-200 p-6 text-center">
                    <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-3xl text-white">‚úì</span>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">Welcome, @currentUser!</h3>
                    <p class="text-gray-600 mb-6">You're successfully logged in.</p>
                    <button @onclick="HandleLogout"
                        class="px-6 py-2 bg-purple-600 text-white font-medium rounded hover:bg-purple-700 transition-colors">
                        Sign Out
                    </button>
                </div>
            }
        </div>

        <!-- Sample Component -->
        <div class="bg-white rounded-xl p-6 border border-gray-200 mb-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">üß© Sample Component: Login.razor</h2>

            <p class="text-sm text-gray-600 mb-4">
                A complete login component with fake authentication and state management.
            </p>

            <div class="bg-gray-100 border border-gray-200 rounded-lg p-4 overflow-x-auto mb-4">
                <div class="text-xs text-gray-500 mb-1">Login.razor</div>
                <pre data-code-title="Razor (Login.razor)"
                    class="code-block text-xs sm:text-sm font-mono text-gray-800 w-full max-w-full overflow-x-auto">@@page "/login"
@@rendermode InteractiveServer

&lt;PageTitle&gt;Login&lt;/PageTitle&gt;

@@if (!isAuthenticated)
{
    &lt;div class="min-h-screen bg-gradient-to-br from-purple-50 to-indigo-100 flex items-center justify-center p-4"&gt;
        &lt;div class="max-w-md w-full bg-white rounded-2xl border-2 border-gray-200 p-8"&gt;
            &lt;h1 class="text-2xl font-bold text-gray-900 mb-6 text-center"&gt;Login&lt;/h1&gt;

            @@if (!string.IsNullOrEmpty(errorMessage))
            {
                &lt;div class="mb-4 p-3 bg-red-50 border border-red-200 rounded text-red-700 text-sm"&gt;
                    @@errorMessage
                &lt;/div&gt;
            }

            &lt;div class="space-y-4"&gt;
                &lt;div&gt;
                    &lt;label class="block text-sm font-medium text-gray-700 mb-2"&gt;Email&lt;/label&gt;
                    &lt;input type="email" @@bind="email" @@bind:event="oninput"
                        class="w-full rounded border border-gray-300 p-3" /&gt;
                &lt;/div&gt;
                &lt;div&gt;
                    &lt;label class="block text-sm font-medium text-gray-700 mb-2"&gt;Password&lt;/label&gt;
                    &lt;input type="password" @@bind="password" @@bind:event="oninput"
                        @@onkeydown="@@(e => { if (e.Key == "Enter") HandleLogin(); })"
                        class="w-full rounded border border-gray-300 p-3" /&gt;
                &lt;/div&gt;
            &lt;/div&gt;

            &lt;button @@onclick="HandleLogin"
                class="w-full mt-6 bg-purple-600 text-white font-medium py-3 rounded hover:bg-purple-700"&gt;
                Sign In
            &lt;/button&gt;
        &lt;/div&gt;
    &lt;/div&gt;
}
else
{
    &lt;div class="min-h-screen flex items-center justify-center p-4"&gt;
        &lt;div class="text-center"&gt;
            &lt;h1 class="text-2xl font-bold text-gray-900 mb-4"&gt;Welcome, @@currentUser!&lt;/h1&gt;
            &lt;button @@onclick="HandleLogout"
                class="px-6 py-2 bg-purple-600 text-white font-medium rounded"&gt;
                Sign Out
            &lt;/button&gt;
        &lt;/div&gt;
    &lt;/div&gt;
}

@@code {
    private bool isAuthenticated = false;
    private string email = "";
    private string password = "";
    private string errorMessage = "";
    private string currentUser = "";

    // Hardcoded demo credentials
    private const string AdminEmail = "admin@example.com";
    private const string AdminPassword = "admin123";

    private void HandleLogin()
    {
        if (email == AdminEmail && password == AdminPassword)
        {
            isAuthenticated = true;
            currentUser = "Admin User";
            errorMessage = "";
            email = "";
            password = "";
        }
        else
        {
            errorMessage = "Invalid email or password. Try admin@example.com / admin123";
        }
    }

    private void HandleLogout()
    {
        isAuthenticated = false;
        currentUser = "";
    }
}</pre>
            </div>

            <!-- Step-by-step breakdown -->
            <h3 class="text-sm font-semibold text-gray-800 mb-2">Step-by-step breakdown</h3>
            <div class="grid gap-4">
                <div class="bg-gray-100 border border-gray-200 rounded-lg p-4">
                    <div class="text-xs text-gray-500 mb-1">1. State variables</div>
                    <p class="text-xs text-gray-600 mb-2">Track authentication status and form data in @@code block.</p>
                    <pre class="code-block text-xs sm:text-sm font-mono text-gray-800 w-full max-w-full overflow-x-auto">@@@@code {
    private bool isAuthenticated = false;
    private string email = "";
    private string password = "";
    private string errorMessage = "";
    private string currentUser = "";
}</pre>
                </div>

                <div class="bg-gray-100 border border-gray-200 rounded-lg p-4">
                    <div class="text-xs text-gray-500 mb-1">2. Form inputs with @@bind</div>
                    <p class="text-xs text-gray-600 mb-2">Bind input values to variables for real-time updates.</p>
                    <pre class="code-block text-xs sm:text-sm font-mono text-gray-800 w-full max-w-full overflow-x-auto">&lt;input type="email" @@bind="email" @@bind:event="oninput" /&gt;
&lt;input type="password" @@bind="password" @@bind:event="oninput" /&gt;</pre>
                </div>

                <div class="bg-gray-100 border border-gray-200 rounded-lg p-4">
                    <div class="text-xs text-gray-500 mb-1">3. Login validation</div>
                    <p class="text-xs text-gray-600 mb-2">Check credentials and update authentication state.</p>
                    <pre class="code-block text-xs sm:text-sm font-mono text-gray-800 w-full max-w-full overflow-x-auto">private void HandleLogin()
{
    if (email == AdminEmail && password == AdminPassword)
    {
        isAuthenticated = true;
        currentUser = "Admin User";
        errorMessage = "";
    }
    else
    {
        errorMessage = "Invalid credentials";
    }
}</pre>
                </div>

                <div class="bg-gray-100 border border-gray-200 rounded-lg p-4">
                    <div class="text-xs text-gray-500 mb-1">4. Conditional rendering</div>
                    <p class="text-xs text-gray-600 mb-2">Show different UI based on authentication state.</p>
                    <pre class="code-block text-xs sm:text-sm font-mono text-gray-800 w-full max-w-full overflow-x-auto">@@if (!isAuthenticated)
{
    &lt;!-- Show login form --&gt;
}
else
{
    &lt;!-- Show welcome message --&gt;
}</pre>
                </div>
            </div>
        </div>

        <!-- Key Takeaways -->
        <div class="bg-blue-50 border border-blue-200 rounded-2xl p-5 sm:p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-3">üéØ Key Takeaways</h2>
            <ul class="list-disc ml-6 text-sm sm:text-base text-gray-700 space-y-2">
                <li><strong>@@bind directive:</strong> Creates two-way data binding between inputs and C# variables</li>
                <li><strong>Conditional rendering:</strong> Use @@if to show different UI based on state</li>
                <li><strong>Event handling:</strong> @@onclick and @@onkeydown trigger C# methods</li>
                <li><strong>State management:</strong> Boolean flags control app behavior and visibility</li>
                <li><strong>Form validation:</strong> Check user input before updating state</li>
            </ul>
        </div>

        <!-- Mark Complete Section -->
        <div class="bg-white rounded-xl p-6 border-2 border-green-200 mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-1">Ready to move on?</h3>
                    <p class="text-sm text-gray-600">Mark this step as complete to track your Admin progress.</p>
                </div>
                @if (isComplete)
                {
                    <div class="flex items-center gap-3">
                        <span class="px-4 py-2 rounded-full bg-green-100 text-green-700 font-medium">‚úì Completed</span>
                        <button @onclick="ResetStep"
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-sm">Reset</button>
                    </div>
                }
                else
                {
                    <button @onclick="MarkComplete"
                        class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">
                        Mark as Complete
                    </button>
                }
            </div>
        </div>

        <!-- Navigation -->
        <div class="mt-8">
            <div class="bg-black/90 rounded-2xl p-6 sm:p-8 text-white text-center">
                <p class="text-lg sm:text-xl font-semibold mb-4">Continue Learning</p>
                <p class="text-sm text-gray-300 mb-6 max-w-2xl mx-auto">
                    Authentication works! Next, let's protect routes and components from unauthorized access.
                </p>
                <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
                    <a href="/admin-guide"
                        class="inline-flex items-center gap-2 px-6 py-3 bg-white/10 hover:bg-white/20 rounded-xl transition-colors">
                        <span class="text-lg">‚Üê</span>
                        <span class="text-sm sm:text-base font-semibold">Back to Guide</span>
                    </a>
                    <a href="/admin-examples/step201"
                        class="inline-flex items-center gap-2 px-6 py-3 bg-white/10 hover:bg-white/20 rounded-xl transition-colors">
                        <span class="text-lg">‚Üê</span>
                        <span class="text-sm sm:text-base font-semibold">Previous: Step 2</span>
                    </a>
                    <a href="/admin-examples/step203"
                        class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-xl transition-colors">
                        <span class="text-sm sm:text-base font-semibold">Next: Step 4</span>
                        <span class="text-lg">‚Üí</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // Demo state
    private bool isAuthenticated = false;
    private string email = "";
    private string password = "";
    private string errorMessage = "";
    private string currentUser = "";

    // Step progress state
    private bool isComplete;
    private IJSObjectReference? _copyModule;

    protected override async Task OnInitializedAsync()
    {
        var step = await ProgressService.GetStepAsync("admin", 202);
        isComplete = step?.IsComplete ?? false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                _copyModule = await JS.InvokeAsync<IJSObjectReference>("import", "./js/codeblocks.js");
                await _copyModule.InvokeVoidAsync("enhancePreBlocks");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Failed to load code block enhancer: {ex.Message}");
            }
        }
    }

    private async Task MarkComplete()
    {
        await ProgressService.MarkStepCompleteAsync("admin", 202);
        isComplete = true;
    }

    private async Task ResetStep()
    {
        await ProgressService.MarkStepIncompleteAsync("admin", 202);
        isComplete = false;
    }

    // Demo login methods
    private void HandleLogin()
    {
        if (email == "admin@example.com" && password == "admin123")
        {
            isAuthenticated = true;
            currentUser = "Admin User";
            errorMessage = "";
            email = "";
            password = "";
        }
        else
        {
            errorMessage = "Invalid email or password. Try admin@example.com / admin123";
        }
    }

    private void HandleLogout()
    {
        isAuthenticated = false;
        currentUser = "";
    }

    public void Dispose()
    {
        _copyModule?.DisposeAsync();
    }
}
