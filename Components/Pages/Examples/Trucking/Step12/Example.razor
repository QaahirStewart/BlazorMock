@page "/trucking-examples/step12"
@rendermode InteractiveServer

<PageTitle>Step 12: Pay & Expense Calculation - Trucking Tutorial</PageTitle>

<div class="min-h-screen py-8 rounded-4xl bg-gray-50">
    <div class="w-full mx-auto px-4 max-w-5xl">
        <!-- Header -->
        <a href="/trucking-guide"
            class="inline-flex items-center gap-2 text-sm sm:text-base text-blue-600 hover:text-blue-700 mb-4">
            <span>‚Üê</span> Back to Trucking Guide
        </a>

        <h1 class="text-4xl font-bold text-gray-900 mb-4">
            üí∞ Step 12: Pay & Expense Calculation
        </h1>
        <p class="text-xl text-gray-600 mb-8">
            Build a service to calculate driver pay and route expenses.
        </p>

        <!-- What You'll Learn -->
        <div class="bg-gradient-to-r from-gray-100 to-blue-100 rounded-2xl p-5 sm:p-6 mb-6">
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-4">What You'll Learn</h2>

            <p class="text-gray-700 mb-4 text-sm sm:text-base">
                Services encapsulate business logic and keep calculations centralized. This step shows you how to create
                a
                ScheduleService that handles all pay and expense calculations with reusable, testable methods.
            </p>

            <ul class="list-disc ml-6 text-sm sm:text-base text-gray-700 space-y-2 mb-4">
                <li>Create a service for business calculations</li>
                <li>Calculate driver pay based on multiple factors (experience, route type, bonuses)</li>
                <li>Estimate route costs and fuel expenses</li>
                <li>Calculate profitability and suggested profit margins</li>
            </ul>

            <!-- Key Concepts Footer -->
            <div class="mt-2 pt-3 border-t border-blue-200">
                <p class="text-xs sm:text-sm text-gray-700 mb-2">
                    <strong>üí° Key Concepts:</strong> Service Pattern, Business Logic, Calculation Methods, Constants
                </p>
                <div class="flex flex-wrap items-center gap-2">
                    <span class="text-xs sm:text-sm text-gray-600">‚Üí Related tips:</span>
                    <a href="/tips#service-pattern"
                        class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-[11px] sm:text-xs font-medium hover:bg-blue-200 transition-colors">Service
                        Pattern</a>
                    <a href="/tips#business-logic"
                        class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-[11px] sm:text-xs font-medium hover:bg-blue-200 transition-colors">Business
                        Logic</a>
                    <a href="/tips#calculation-methods"
                        class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-[11px] sm:text-xs font-medium hover:bg-blue-200 transition-colors">Calculation
                        Methods</a>
                </div>
            </div>
        </div>

        <!-- Sample Component -->
        <div class="bg-white rounded-xl p-6 border border-gray-200 mb-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">üß© Sample Component: ScheduleService</h2>

            <p class="text-sm text-gray-600 mb-4">
                The ScheduleService encapsulates all pay and expense calculation logic in one place.
                This makes the formulas easy to maintain, test, and reuse across multiple components. The interactive demo 
                below uses these exact same formulas so you can see them in action.
            </p>

            <div class="bg-gray-100 border border-gray-200 rounded-lg p-4 overflow-x-auto mb-4">
                <div class="text-xs text-gray-500 mb-1">Services/ScheduleService.cs</div>
                <p class="text-xs text-gray-600 mb-2">
                    This service provides methods to calculate driver pay with bonuses, estimate fuel costs, and suggest
                    minimum revenue for profitability.
                </p>
                <ul class="list-disc ml-4 mb-3 text-[11px] text-gray-600 space-y-1">
                    <li>Constants for fuel price and MPG allow easy updates without changing logic</li>
                    <li>CalculateDriverPay includes experience multiplier and route-specific bonuses</li>
                    <li>Switch expressions make route-type logic clean and readable</li>
                    <li>SuggestMinimumRevenue adds 20% margin to ensure profitability</li>
                </ul>
                <pre data-code-title="C# (Services/ScheduleService.cs)"
                    class="code-block text-xs sm:text-sm font-mono text-gray-800 w-full max-w-full overflow-x-auto">
public class ScheduleService
{
    private const decimal FuelPricePerGallon = 3.85m;
    private const double AverageMpg = 6.5;

    public decimal CalculateDriverPay(Route route, Driver driver)
    {
        double driveTime = route.GetEstimatedDriveTime();
        decimal basePay = driver.HourlyRate * (decimal)driveTime;
        
        // Experience bonus (1% per year, max 25%)
        decimal experienceMultiplier = 1.0m + Math.Min(driver.YearsOfExperience * 0.01m, 0.25m);
        decimal payWithExperience = basePay * experienceMultiplier;

        // Route type bonuses
        decimal routeBonus = route.Type switch
        {
            RouteType.Hazmat => 250m,
            RouteType.Oversized => 300m,
            RouteType.LongHaul => route.DistanceMiles * 0.15m,
            _ => 0m
        };

        return payWithExperience + routeBonus;
    }

    public decimal EstimateFuelCost(int distanceMiles)
    {
        double gallonsNeeded = distanceMiles / AverageMpg;
        return (decimal)gallonsNeeded * FuelPricePerGallon;
    }

    public decimal CalculateTotalRouteCost(Route route, Driver driver)
    {
        decimal driverPay = CalculateDriverPay(route, driver);
        decimal fuelCost = EstimateFuelCost(route.DistanceMiles);
        decimal otherCosts = route.DistanceMiles * 0.10m;
        
        return driverPay + fuelCost + otherCosts;
    }

    public decimal SuggestMinimumRevenue(Route route, Driver driver)
    {
        decimal totalCost = CalculateTotalRouteCost(route, driver);
        return totalCost * 1.20m; // 20% profit margin
    }
}
                </pre>
            </div>

            <h3 class="text-sm font-semibold text-gray-800 mb-2">Step-by-step breakdown</h3>
            <div class="grid gap-4">
                <div class="bg-gray-100 border border-gray-200 rounded-lg p-4">
                    <div class="text-xs text-gray-500 mb-1">1. Register the service</div>
                    <p class="text-xs text-gray-600 mb-2">
                        Add the ScheduleService to dependency injection so it can be injected into components.
                    </p>
                    <ul class="list-disc ml-4 mb-2 text-[11px] text-gray-600 space-y-1">
                        <li>Use Scoped lifetime for per-request services</li>
                        <li>Register in Program.cs before building the app</li>
                    </ul>
                    <pre
                        class="code-block text-xs sm:text-sm font-mono text-gray-800 w-full max-w-full overflow-x-auto">// Program.cs
builder.Services.AddScoped&lt;ScheduleService&gt;();</pre>
                </div>
            </div>
        </div>

        <!-- Important Notes & Tips -->
        <div class="bg-white rounded-xl p-6 border border-gray-200 mb-6">
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-4">üìù Important Notes & Tips</h2>

            <div class="space-y-3">
                <!-- Pro Tips (Blue) -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 class="text-sm font-bold text-blue-900 mb-3">üí° Pro Tips</h3>
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm font-semibold text-blue-900 mb-2">Use constants for values that may change
                            </p>
                            <p class="text-xs text-blue-800">
                                Fuel prices, tax rates, and business rules change over time. Define them as constants at
                                the top of your service
                                so you can update them in one place instead of hunting through complex formulas.
                            </p>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-blue-900 mb-2">Calculate and save values before storing
                            </p>
                            <p class="text-xs text-blue-800">
                                Don't store raw inputs and recalculate every time. Calculate derived values (like total
                                cost, profit margin)
                                once when creating the route, then save them to the database. This improves performance
                                and preserves historical accuracy.
                            </p>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-blue-900 mb-2">Keep services focused and testable</p>
                            <p class="text-xs text-blue-800">
                                ScheduleService should only handle calculations. Don't mix in database access,
                                validation, or UI logic.
                                This makes it easy to write unit tests and reuse in different contexts.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Troubleshooting (Yellow) -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h3 class="text-sm font-bold text-yellow-900 mb-2">‚ö†Ô∏è Troubleshooting</h3>
                    <ul class="list-disc ml-6 text-sm text-yellow-900 space-y-1">
                        <li>Service not found when injecting? Register it in Program.cs with
                            AddScoped&lt;ScheduleService&gt;()</li>
                        <li>Calculations showing incorrect values? Use decimal for money, not double. Check constants
                            are correct</li>
                        <li>Rounding errors in totals? Use Math.Round(value, 2) for currency values</li>
                        <li>Negative profit margins? Verify expense calculations include all costs (fuel, pay, overhead)
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- How to do it -->
        <div class="bg-gradient-to-r from-gray-100 to-blue-100 rounded-2xl p-5 sm:p-6 mb-6">
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-4">üõ†Ô∏è How to do it</h2>
            <ol class="list-decimal ml-5 space-y-2 text-gray-700 text-sm sm:text-base">
                <li>
                    <strong>Create ScheduleService.cs:</strong>
                    Add a new file <code>Services/ScheduleService.cs</code> with constants and calculation methods.
                </li>
                <li>
                    <strong>Define calculation methods:</strong>
                    Create methods like CalculateDriverPay, EstimateFuelCost, CalculateTotalRouteCost, and
                    SuggestMinimumRevenue.
                </li>
                <li>
                    <strong>Use switch expressions:</strong>
                    For route-type bonuses, use modern C# switch expressions for clean, readable logic.
                </li>
                <li>
                    <strong>Register the service:</strong>
                    In <code>Program.cs</code>, add <code>builder.Services.AddScoped&lt;ScheduleService&gt;();</code>
                </li>
                <li>
                    <strong>Inject and use:</strong>
                    In your route creation form, inject ScheduleService and call methods to calculate values before
                    saving.
                </li>
                <li>
                    <strong>Test it:</strong>
                    Navigate to <code>/trucking-examples/step12</code> to review the service code and calculations.
                </li>
            </ol>
        </div>

        <!-- Live Demo -->
        <div class="bg-black/3 rounded-2xl p-6 mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">üé¨ Live Demo: Interactive Calculator</h2>
            <p class="text-sm text-gray-600 mb-4">
                Adjust the values below to see how different factors affect driver pay, costs, and profitability in
                real-time.
            </p>

            <div class="bg-white rounded-2xl border border-gray-200 p-6">
                <!-- Input Controls -->
                <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Distance (miles)</label>
                        <input type="number" @bind="demoDistance" @bind:event="oninput"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            min="100" max="2000" step="50" />
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Hourly Rate ($)</label>
                        <input type="number" @bind="demoHourlyRate" @bind:event="oninput"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            min="20" max="50" step="1" />
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Experience (years)</label>
                        <input type="number" @bind="demoExperience" @bind:event="oninput"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            min="0" max="30" step="1" />
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Route Type</label>
                        <select @bind="demoRouteType"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="Standard">Standard</option>
                            <option value="Hazmat">Hazmat (+$250)</option>
                            <option value="Oversized">Oversized (+$300)</option>
                            <option value="LongHaul">Long Haul (+$0.15/mi)</option>
                        </select>
                    </div>
                </div>

                <!-- Calculation Breakdown -->
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Driver Pay Breakdown -->
                    <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                        <h3 class="text-sm font-bold text-blue-900 mb-3">üí∞ Driver Pay Breakdown</h3>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between">
                                <span class="text-blue-800">Base Pay (@(DriveTime.ToString("F1")) hrs √ó
                                    $@demoHourlyRate)</span>
                                <span class="font-semibold text-blue-900">$@BasePay.ToString("N2")</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-800">Experience Bonus (@(demoExperience)% - max 25%)</span>
                                <span class="font-semibold text-blue-900">+ $@ExperienceBonus.ToString("N2")</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-blue-800">@demoRouteType Route Bonus</span>
                                <span class="font-semibold text-blue-900">+ $@RouteBonus.ToString("N2")</span>
                            </div>
                            <div class="flex justify-between pt-2 border-t-2 border-blue-300">
                                <span class="font-bold text-blue-900">Total Driver Pay</span>
                                <span class="font-bold text-blue-900 text-base">$@TotalDriverPay.ToString("N2")</span>
                            </div>
                        </div>
                    </div>

                    <!-- Cost & Revenue Breakdown -->
                    <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                        <h3 class="text-sm font-bold text-green-900 mb-3">üìä Cost & Revenue Analysis</h3>
                        <div class="space-y-2 text-xs">
                            <div class="flex justify-between">
                                <span class="text-green-800">Driver Pay</span>
                                <span class="font-semibold text-green-900">$@TotalDriverPay.ToString("N2")</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-green-800">Fuel Cost (@(demoDistance / AverageMpg).ToString("F1") gal
                                    √ó $@FuelPricePerGallon)</span>
                                <span class="font-semibold text-green-900">$@FuelCost.ToString("N2")</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-green-800">Other Costs (@demoDistance mi √ó $@OtherCostPerMile)</span>
                                <span class="font-semibold text-green-900">$@OtherCosts.ToString("N2")</span>
                            </div>
                            <div class="flex justify-between pt-2 border-t border-green-300">
                                <span class="font-semibold text-green-900">Total Cost</span>
                                <span class="font-semibold text-red-600">$@TotalCost.ToString("N2")</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="font-semibold text-green-900">Min Revenue (20% margin)</span>
                                <span class="font-semibold text-green-700">$@MinimumRevenue.ToString("N2")</span>
                            </div>
                            <div class="flex justify-between pt-2 border-t-2 border-green-300">
                                <span class="font-bold text-green-900">Profit</span>
                                <span class="font-bold text-green-900 text-base">$@Profit.ToString("N2")</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Key Insights -->
                <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="text-xs text-yellow-900">
                        <strong>üí° Insights:</strong>
                        @if (demoExperience >= 25)
                        {
                            <span>Driver is at max experience bonus (25%). </span>
                        }
                        @if (RouteBonus > 0)
                        {
                            <span>@demoRouteType route bonus adds $@RouteBonus.ToString("N2") to driver pay. </span>
                        }
                        @if (demoDistance > 1000)
                        {
                            <span>Long distance increases fuel costs significantly. </span>
                        }
                        Profit margin: @((Profit / TotalCost * 100).ToString("F1"))%
                    </p>
                </div>
            </div>

            <p class="text-xs text-gray-600 mt-4 text-center">
                üí° Try different combinations to see how experience, route type, and distance affect profitability.
            </p>
        </div>

        <!-- Mark Complete Section -->
        <div class="bg-white rounded-xl p-6 border-2 border-green-200 mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-1">Finished Step 12?</h3>
                    <p class="text-sm text-gray-600">Mark this step complete to track your progress!</p>
                </div>
                @if (isComplete)
                {
                    <div class="flex items-center gap-3">
                        <span class="px-4 py-2 rounded-full bg-green-100 text-green-700 font-medium">‚úì Completed</span>
                        <button @onclick="@(async () => await ProgressService.MarkStepIncompleteAsync(12))"
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-sm">Reset</button>
                    </div>
                }
                else
                {
                    <button @onclick="MarkComplete"
                        class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded font-medium transition-colors">
                        Mark as Complete
                    </button>
                }
            </div>
        </div>

        <!-- Navigation -->
        <div class="mt-8">
            <div class="bg-black/90 rounded-2xl p-6 sm:p-8 text-white text-center">
                <p class="text-lg sm:text-xl font-semibold mb-4">Continue Learning</p>
                <p class="text-sm text-gray-300 mb-6 max-w-2xl mx-auto">
                    JavaScript interop done! Let's add error handling and final touches.
                </p>
                <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
                    <a href="/trucking-guide"
                        class="inline-flex items-center gap-2 px-6 py-3 bg-white/10 hover:bg-white/20 rounded-xl transition-colors">
                        <span class="text-lg">‚Üê</span>
                        <span class="text-sm sm:text-base font-semibold">Back to Guide</span>
                    </a>
                    <a href="/trucking-examples/step11"
                        class="inline-flex items-center gap-2 px-6 py-3 bg-white/10 hover:bg-white/20 rounded-xl transition-colors">
                        <span class="text-lg">‚Üê</span>
                        <span class="text-sm sm:text-base font-semibold">Previous: Step 11</span>
                    </a>
                    <a href="/trucking-examples/step13"
                        class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-xl transition-colors">
                        <span class="text-sm sm:text-base font-semibold">Next: Step 13</span>
                        <span class="text-lg">‚Üí</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>