@page "/examples/step10"
@inject ILearningProgressService ProgressService
@rendermode InteractiveServer

<div class="min-h-screen py-8 bg-gray-50">
    <div class="w-full mx-auto px-4 max-w-5xl">
        <div class="mb-8">
            <a href="/guide" class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-700 mb-4">
                <span>‚Üê</span> Back to Guide
            </a>
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
                <div class="min-w-0 flex-1">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-2 break-words">üéØ Step 10: State Management</h1>
                    <p class="text-base sm:text-lg md:text-xl text-gray-600 leading-relaxed break-words">Share data between components using services and cascading parameters.</p>
                </div>
                
            </div>
        </div>

    <div class="bg-white rounded-xl p-6 border border-gray-200 mb-6">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4 break-words">
                üéØ Learning Objectives
            </h2>
            <ul class="space-y-2 text-sm sm:text-base lg:text-lg text-gray-700">
                <li class="flex items-start gap-2">
                    <span class="text-green-500 flex-shrink-0 mt-1">‚úì</span>
                    <span class="break-words min-w-0">Create a state management service</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="text-green-500 flex-shrink-0 mt-1">‚úì</span>
                    <span class="break-words min-w-0">Understand service lifetimes (Scoped, Singleton, Transient)</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="text-green-500 flex-shrink-0 mt-1">‚úì</span>
                    <span class="break-words min-w-0">Use events to notify components of state changes</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="text-green-500 flex-shrink-0 mt-1">‚úì</span>
                    <span class="break-words min-w-0">Implement cascading parameters for app-wide data</span>
                </li>
            </ul>
        </div>

    <div class="bg-white rounded-xl p-6 border border-gray-200 mb-6">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4 break-words">
                üèóÔ∏è Create AppState Service
            </h2>
            
            <div class="bg-gray-100 rounded-lg p-4 overflow-x-auto mb-4">
                <pre class="text-xs sm:text-sm text-gray-800 font-mono"><code>// Services/AppState.cs
namespace BlazorMock.Services;

public class AppState
{
    // Private field to store the selected driver
    private Driver? _selectedDriver;

    // Public property with private setter
    public Driver? SelectedDriver
    {
        get =&gt; _selectedDriver;
        private set
        {
            _selectedDriver = value;
            NotifyStateChanged();
        }
    }

    // Event to notify subscribers of state changes
    public event Action? OnChange;

    // Method to update the selected driver
    public void SelectDriver(Driver? driver)
    {
        SelectedDriver = driver;
    }

    // Method to clear selection
    public void ClearSelection()
    {
        SelectedDriver = null;
    }

    // Notify all subscribers that state has changed
    private void NotifyStateChanged() =&gt; OnChange?.Invoke();
}</code></pre>
            </div>

            <div class="bg-blue-50 border-l-4 border-blue-500 p-4">
                <p class="text-sm sm:text-base text-blue-800 break-words">
                    <strong>üí° Pro Tip:</strong> Use events (Action) to notify components when state changes so they can update their UI!
                </p>
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 border border-gray-200 mb-6">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4 break-words">
                üîß Register Service in Program.cs
            </h2>
            
            <div class="bg-gray-100 rounded-lg p-4 overflow-x-auto mb-4">
                <pre class="text-xs sm:text-sm text-gray-800 font-mono"><code>// Program.cs
using BlazorMock.Services;

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddRazorComponents()
    .AddInteractiveServerComponents();

// Register AppState as a SCOPED service
// Scoped = one instance per user session
builder.Services.AddScoped&lt;AppState&gt;();

var app = builder.Build();</code></pre>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <h3 class="font-semibold text-blue-900 mb-2 text-sm sm:text-base break-words">
                        Scoped
                    </h3>
                    <p class="text-xs sm:text-sm text-blue-800 break-words">
                        One instance per user/circuit. Perfect for user-specific state.
                    </p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg border border-green-100">
                    <h3 class="font-semibold text-green-900 mb-2 text-sm sm:text-base break-words">
                        Singleton
                    </h3>
                    <p class="text-xs sm:text-sm text-green-800 break-words">
                        One instance for entire app. Shared across ALL users.
                    </p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg border border-purple-100">
                    <h3 class="font-semibold text-purple-900 mb-2 text-sm sm:text-base break-words">
                        Transient
                    </h3>
                    <p class="text-xs sm:text-sm text-purple-800 break-words">
                        New instance every time injected. Rarely used in Blazor.
                    </p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 border border-gray-200 mb-6">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4 break-words">
                üìù Use State in Components
            </h2>
            
            <div class="bg-gray-100 rounded-lg p-4 overflow-x-auto mb-4">
                <pre class="text-xs sm:text-sm text-gray-800 font-mono"><code>// DriverList.razor
@@page "/drivers"
@@inject AppState AppState
@@implements IDisposable

&lt;h1&gt;Select a Driver&lt;/h1&gt;

@@foreach (var driver in drivers)
{
    &lt;div class="driver-card @@GetSelectedClass(driver)"
         @@onclick="() =&gt; SelectDriver(driver)"&gt;
        &lt;h3&gt;@@driver.Name&lt;/h3&gt;
        &lt;p&gt;@@driver.LicenseLevel&lt;/p&gt;
    &lt;/div&gt;
}

@@code {
    private List&lt;Driver&gt; drivers = new();

    protected override void OnInitialized()
    {
        // Subscribe to state changes
        AppState.OnChange += StateHasChanged;
    }

    private void SelectDriver(Driver driver)
    {
        // Update the global state
        AppState.SelectDriver(driver);
    }

    private string GetSelectedClass(Driver driver)
    {
        return driver.Id == AppState.SelectedDriver?.Id 
            ? "selected" 
            : "";
    }

    // Clean up subscription when component is disposed
    public void Dispose()
    {
        AppState.OnChange -= StateHasChanged;
    }
}</code></pre>
            </div>

            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4">
                <p class="text-sm sm:text-base text-yellow-800 break-words">
                    <strong>‚ö†Ô∏è Important:</strong> Always implement IDisposable and unsubscribe from events to prevent memory leaks!
                </p>
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 border border-gray-200 mb-6">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4 break-words">
                üëÅÔ∏è Display State in Another Component
            </h2>
            
            <div class="bg-gray-100 rounded-lg p-4 overflow-x-auto mb-4">
                <pre class="text-xs sm:text-sm text-gray-800 font-mono"><code>// DriverDetails.razor
@@inject AppState AppState
@@implements IDisposable

&lt;div class="driver-details"&gt;
    @@if (AppState.SelectedDriver != null)
    {
        &lt;h2&gt;Selected Driver&lt;/h2&gt;
        &lt;p&gt;&lt;strong&gt;Name:&lt;/strong&gt; @@AppState.SelectedDriver.Name&lt;/p&gt;
        &lt;p&gt;&lt;strong&gt;License:&lt;/strong&gt; @@AppState.SelectedDriver.LicenseLevel&lt;/p&gt;
        &lt;p&gt;&lt;strong&gt;Experience:&lt;/strong&gt; @@AppState.SelectedDriver.YearsOfExperience years&lt;/p&gt;
        
        &lt;button @@onclick="ClearSelection"&gt;Clear Selection&lt;/button&gt;
    }
    else
    {
        &lt;p&gt;No driver selected&lt;/p&gt;
    }
&lt;/div&gt;

@@code {
    protected override void OnInitialized()
    {
        // Subscribe to state changes
        AppState.OnChange += StateHasChanged;
    }

    private void ClearSelection()
    {
        AppState.ClearSelection();
    }

    public void Dispose()
    {
        AppState.OnChange -= StateHasChanged;
    }
}</code></pre>
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 border border-gray-200 mb-6">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4 break-words">
                üîë Key Takeaways
            </h2>
            <ul class="space-y-3 text-sm sm:text-base lg:text-lg text-gray-700">
                <li class="flex items-start gap-2">
                    <span class="text-green-500 flex-shrink-0 mt-1">‚úì</span>
                    <span class="break-words min-w-0">State services share data between components</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="text-green-500 flex-shrink-0 mt-1">‚úì</span>
                    <span class="break-words min-w-0">Use Scoped lifetime for per-user state</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="text-green-500 flex-shrink-0 mt-1">‚úì</span>
                    <span class="break-words min-w-0">Events (`Action`) notify components of changes</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="text-green-500 flex-shrink-0 mt-1">‚úì</span>
                    <span class="break-words min-w-0">Call `StateHasChanged()` to trigger UI updates</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="text-green-500 flex-shrink-0 mt-1">‚úì</span>
                    <span class="break-words min-w-0">Always dispose of event subscriptions</span>
                </li>
            </ul>
        </div>

        <div class="bg-white rounded-xl p-6 border-2 border-green-200">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                <div class="min-w-0 flex-1">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-900 mb-2 break-words">Ready to move on?</h3>
                    <p class="text-sm sm:text-base text-gray-600 break-words">Mark this step as complete to track your progress!</p>
                </div>
                @if (isComplete)
                {
                    <div class="flex items-center gap-3">
                        <span class="px-4 py-2 rounded-full bg-green-100 text-green-700 font-medium">‚úì Completed</span>
                        <button @onclick="@(async ()=> await ProgressService.MarkStepIncompleteAsync(10))" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-sm">Reset</button>
                    </div>
                }
                else
                {
                    <button @onclick="MarkComplete" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">Mark as Complete</button>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private bool isComplete = false;

    protected override async Task OnInitializedAsync()
    {
        var step = await ProgressService.GetStepAsync(10);
        isComplete = step?.IsComplete ?? false;
    }

    private async Task MarkComplete()
    {
        await ProgressService.MarkStepCompleteAsync(10);
        isComplete = true;
    }
}
