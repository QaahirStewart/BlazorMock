@page "/admin-dashboard-examples/step10"
@rendermode InteractiveServer
@using BlazorMock.Components.Pages.Examples.AdminDashboard.Step10
@inherits ExampleBase

<PageTitle>Admin Dashboard Step 10: Route Protection & Roles - Example</PageTitle>

<div class="min-h-screen py-8 rounded-4xl bg-gray-50">
    <div class="w-full mx-auto px-4 max-w-5xl">
        <a href="/admin-dashboard-guide"
            class="inline-flex items-center gap-2 text-sm sm:text-base text-blue-600 hover:text-blue-700 mb-4">
            <span>‚Üê</span> Back to Admin Dashboard Guide
        </a>

        <h1 class="text-4xl font-bold text-gray-900 mb-4">
            üîê Step 10: Route Protection &amp; Roles (Real App Edition)
        </h1>

        <p class="text-xl text-gray-600 mb-8">
            Copy the exact guard flow the live demo uses: <code>/profile</code> and <code>/analytics</code> kick
            anonymous users back to <code>/signin</code>, free users see upgrade prompts, and admins unlock the entire
            dashboard surface powered by <code>IUserAuthService</code>.
        </p>

        <div class="bg-gradient-to-r from-gray-100 to-blue-100 rounded-2xl p-5 sm:p-6 mb-6">
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-4">What You'll Learn</h2>
            <ul class="list-disc ml-6 text-sm sm:text-base text-gray-700 space-y-2 mb-4">
                <li>Redirect signed-out visitors the moment they hit <code>/profile</code> or <code>/analytics</code>.
                </li>
                <li>Use the shared auth service (<code>Auth.CurrentUser</code>, <code>IsPaidOrAdmin</code>,
                    <code>IsAdmin</code>) instead of duplicating role math.
                </li>
                <li>Show the real limited-access card free users see in <code>Analytics.razor</code>.</li>
                <li>Keep the admin-only KPIs and user-management shell behind the same guard as Step 9.</li>
            </ul>
            <div class="mt-2 pt-3 border-t border-blue-200">
                <p class="text-xs sm:text-sm text-gray-700 mb-2">
                    <strong>üí° Key Concepts:</strong> deterministic redirects, friendly lockouts, role-based content
                    branches, and avoiding hidden EF queries by reusing <code>IUserAuthService</code>.
                </p>
                <div class="flex flex-wrap items-center gap-2">
                    <span class="text-xs sm:text-sm text-gray-600">‚Üí Related tips:</span>
                    <a href="/tips#auth-service"
                        class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-[11px] sm:text-xs font-medium hover:bg-blue-200 transition-colors">Auth
                        Service</a>
                    <a href="/tips#layout-state"
                        class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-[11px] sm:text-xs font-medium hover:bg-blue-200 transition-colors">Layout
                        State</a>
                    <a href="/tips#tailwind"
                        class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-[11px] sm:text-xs font-medium hover:bg-blue-200 transition-colors">Tailwind
                        Layouts</a>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 border border-gray-200 mb-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">üß© Canonical Guard Patterns</h2>
            <p class="text-sm text-gray-600 mb-4">
                These snippets are lifted directly from the files that power the live demo. Keep them HTML-encoded so
                Razor treats them as documentation, and make sure your tutorial screenshots match these states.
            </p>

            <div class="space-y-5">
                <div class="bg-gray-100 border border-gray-200 rounded-lg p-4 overflow-x-auto">
                    <div class="text-xs text-gray-500 mb-1">Components/Pages/Demo/DashboardDemo/Profile.razor</div>
                    <p class="text-xs text-gray-600 mb-2">Signed-out visitors are bounced to <code>/signin</code>
                        before any profile UI renders.</p>
                    <pre data-code-title="Profile.razor ‚Äî redirect guard"
                        class="code-block text-xs sm:text-sm font-mono text-gray-800 w-full max-w-full overflow-x-auto">@@page "/profile"
@@rendermode InteractiveServer
@@inherits ProfileBase

&lt;PageTitle&gt;My Profile&lt;/PageTitle&gt;

@@if (Auth.CurrentUser == null)
{
    Nav.NavigateTo("/signin");
}
else
{
    &lt;div class="py-10 px-4 bg-gray-50 rounded-3xl"&gt;
        &lt;!-- Full profile layout with avatar editing, stats, etc. --&gt;
    &lt;/div&gt;
}</pre>
                </div>

                <div class="bg-gray-100 border border-gray-200 rounded-lg p-4 overflow-x-auto">
                    <div class="text-xs text-gray-500 mb-1">Components/Pages/Demo/DashboardDemo/Analytics.razor</div>
                    <p class="text-xs text-gray-600 mb-2">After the same redirect guard, the page branches into free
                        vs. paid/admin layouts and tacks on an admin-only KPI bar.</p>
                    <pre data-code-title="Analytics.razor ‚Äî auth + role branches"
                        class="code-block text-xs sm:text-sm font-mono text-gray-800 w-full max-w-full overflow-x-auto">@@page "/analytics"
@@rendermode InteractiveServer
@@inherits AnalyticsBase

&lt;PageTitle&gt;Analytics&lt;/PageTitle&gt;

@@if (Auth.CurrentUser == null)
{
    Nav.NavigateTo("/signin");
}
else
{
    &lt;div class="py-8 bg-gray-50"&gt;
        &lt;!-- Basic metrics visible to every signed-in account --&gt;

        @@if (IsPaidOrAdmin)
        {
            &lt;!-- Advanced cards, traffic sources, etc. --&gt;
        }
        else
        {
            &lt;!-- Upgrade CTA block shown to Free accounts --&gt;
        }

        @@if (IsAdmin)
        {
            &lt;!-- Admin-only aggregate stats pulled from Auth.AllUsers --&gt;
        }
    &lt;/div&gt;
}</pre>
                </div>

                <div class="bg-gray-100 border border-gray-200 rounded-lg p-4 overflow-x-auto">
                    <div class="text-xs text-gray-500 mb-1">Components/Pages/Demo/DashboardDemo/Analytics.razor.cs</div>
                    <p class="text-xs text-gray-600 mb-2">Helpers that keep role math out of the Razor file.</p>
                    <pre data-code-title="AnalyticsBase.cs ‚Äî role helpers"
                        class="code-block text-xs sm:text-sm font-mono text-gray-800 w-full max-w-full overflow-x-auto">public partial class AnalyticsBase : ComponentBase
{
    [Inject] protected IUserAuthService Auth { get; set; } = default!;
    [Inject] protected NavigationManager Nav { get; set; } = default!;

    protected bool IsPaidOrAdmin =&gt; Auth.CurrentUser?.Role == "Paid" || Auth.CurrentUser?.Role == "Admin";
    protected bool IsAdmin =&gt; Auth.CurrentUser?.Role == "Admin";
}</pre>
                </div>

                <div class="bg-gray-100 border border-gray-200 rounded-lg p-4 overflow-x-auto">
                    <div class="text-xs text-gray-500 mb-1">Components/Pages/Demo/DashboardDemo/AdminDashboard.razor
                    </div>
                    <p class="text-xs text-gray-600 mb-2">Same guard as Step 9: non-admins see the friendly lockout
                        card.</p>
                    <pre data-code-title="AdminDashboard.razor ‚Äî friendly lockout"
                        class="code-block text-xs sm:text-sm font-mono text-gray-800 w-full max-w-full overflow-x-auto">@@if (Auth.CurrentUser is null || Auth.CurrentUser.Role != "Admin")
{
    &lt;div class="bg-gray-50 py-12 rounded-3xl"&gt;
        &lt;div class="max-w-md mx-auto px-4"&gt;
            &lt;div class="bg-white rounded-2xl border-2 border-gray-200 p-8 text-center"&gt;
                &lt;h2 class="text-2xl font-bold"&gt;Admin Access Required&lt;/h2&gt;
                &lt;p class="text-gray-600 mb-6"&gt;You need admin privileges to access this page.&lt;/p&gt;
                &lt;a href="/signin" class="block w-full px-6 py-3 bg-blue-600 text-white rounded-lg"&gt;Sign In&lt;/a&gt;
                &lt;a href="/" class="block w-full px-6 py-3 bg-white border-2 border-gray-200 rounded-lg"&gt;Go Home&lt;/a&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;
}
else
{
    &lt;!-- Admin-only dashboard shell (Step 9) --&gt;
}</pre>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl p-6 border border-gray-200 mb-6">
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-4">üìù Important Notes & Tips</h2>
            <div class="space-y-3">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 class="text-sm font-bold text-blue-900 mb-3">üí° Pro Tips</h3>
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm font-semibold text-blue-900 mb-2">Guard ASAP</p>
                            <p class="text-xs text-blue-800">Run the <code>Auth.CurrentUser == null</code> check at the
                                top of the Razor file so protected markup never flashes for logged-out visitors.</p>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-blue-900 mb-2">Reuse service helpers</p>
                            <p class="text-xs text-blue-800"><code>IsPaidOrAdmin</code> and <code>IsAdmin</code> live in
                                <code>AnalyticsBase</code>; keep role math there so Razor stays readable.</p>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-blue-900 mb-2">Friendly fallback states</p>
                            <p class="text-xs text-blue-800">Every lockout card includes context + CTA (e.g. "Upgrade"
                                or "Sign in") so QA screenshots match what real users see.</p>
                        </div>
                    </div>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h3 class="text-sm font-bold text-yellow-900 mb-2">‚ö†Ô∏è Troubleshooting</h3>
                    <ul class="list-disc ml-6 text-sm text-yellow-900 space-y-1">
                        <li>Forgot to inject <code>IUserAuthService</code>? The guard will always treat users as
                            signed-out.</li>
                        <li>Role text mismatch ("admin" vs "Admin") keeps admins from seeing KPIs‚Äîuse the seeded case.
                        </li>
                        <li>Upgrade CTA missing? Verify the <code>IsPaidOrAdmin</code> helper covers both Paid + Admin.
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="bg-gradient-to-r from-gray-100 to-blue-100 rounded-xl p-6 mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">üõ†Ô∏è How to do it</h2>
            <ol class="list-decimal ml-5 space-y-2 text-gray-700 text-sm sm:text-base">
                <li><strong>Inject once:</strong> Pages inherit <code>ProfileBase</code> / <code>AnalyticsBase</code>,
                    so <code>IUserAuthService</code> and <code>NavigationManager</code> are already available‚Äîjust use
                    them.</li>
                <li><strong>Redirect fast:</strong> Call <code>Nav.NavigateTo("/signin")</code> immediately when
                    <code>Auth.CurrentUser</code> is null.</li>
                <li><strong>Branch by role:</strong> Use <code>IsPaidOrAdmin</code> for feature unlocks and
                    <code>IsAdmin</code> for the final KPI layer.</li>
                <li><strong>Keep CTAs in sync:</strong> The upgrade card links back to <code>/profile</code> (the real
                    upgrade button), and the admin lockout links to <code>/signin</code>.</li>
                <li><strong>Test every persona:</strong> Use the seeded Free/Paid/Admin accounts to make sure each route
                    matches the screenshots below.</li>
            </ol>
        </div>

        <div class="bg-black/3 rounded-2xl p-6 mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">üé¨ Live Demo</h2>
            <p class="text-sm text-gray-600 mb-4">
                Launch the seeded accounts in new tabs, then hit refresh on the protected routes to watch the guards do
                their thing. Each button pre-fills <code>/signin</code> with credentials and a redirect.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <a href="/signin?demo=free&redirect=%2Fprofile" target="_blank" rel="noopener"
                    class="bg-white rounded-2xl border border-gray-200 p-4 flex flex-col gap-3 hover:border-blue-400 hover:shadow-lg transition-all duration-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-semibold text-gray-900">Free ‚Üí /profile</h3>
                        <span class="px-2 py-1 text-[11px] rounded-full bg-gray-100 text-gray-700">Redirect</span>
                    </div>
                    <p class="text-xs text-gray-600">Opens /signin with <code>demo=free</code>, then navigates back to
                        /profile. Expect an immediate bounce to sign-in again if you close the tab.</p>
                </a>
                <a href="/signin?demo=paid&redirect=%2Fanalytics" target="_blank" rel="noopener"
                    class="bg-white rounded-2xl border border-gray-200 p-4 flex flex-col gap-3 hover:border-purple-400 hover:shadow-lg transition-all duration-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-semibold text-gray-900">Paid ‚Üí /analytics</h3>
                        <span class="px-2 py-1 text-[11px] rounded-full bg-purple-100 text-purple-800">Paid view</span>
                    </div>
                    <p class="text-xs text-gray-600">Shows both basic metrics and the purple ‚ÄúPaid Feature‚Äù cards, but
                        skips the admin aggregate panel.</p>
                </a>
                <a href="/signin?demo=admin&redirect=%2Fanalytics" target="_blank" rel="noopener"
                    class="bg-white rounded-2xl border border-gray-200 p-4 flex flex-col gap-3 hover:border-red-400 hover:shadow-lg transition-all duration-200">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-semibold text-gray-900">Admin ‚Üí everything</h3>
                        <span class="px-2 py-1 text-[11px] rounded-full bg-red-100 text-red-800">Admin</span>
                    </div>
                    <p class="text-xs text-gray-600">Unlocks the Advanced Analytics grids plus the red admin stats at
                        the bottom, matching the canonical screenshots.</p>
                </a>
            </div>
            <p class="text-xs text-gray-600 mt-4 text-center">After signing in on those tabs, reload
                <code>/profile</code>, <code>/analytics</code>, and <code>/admin/dashboard</code> inside your dev server
                to confirm each guard behaves as described.</p>
        </div>

        <div class="bg-white rounded-xl p-6 border-2 border-green-200 mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-1">Finished Step 10?</h3>
                    <p class="text-sm text-gray-600">Mark this step as complete to track your Admin Dashboard learning
                        progress.</p>
                </div>
                @if (isComplete)
                {
                    <div class="flex items-center gap-3">
                        <span class="px-4 py-2 rounded-full bg-green-100 text-green-700 font-medium">‚úì Completed</span>
                        <button @onclick="ResetStep"
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-sm">
                            Reset
                        </button>
                    </div>
                }
                else
                {
                    <button @onclick="MarkComplete"
                        class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">
                        Mark as Complete
                    </button>
                }
            </div>
        </div>

        <div class="mt-8">
            <div class="bg-black/90 rounded-2xl p-6 sm:p-8 text-white text-center">
                <p class="text-lg sm:text-xl font-semibold mb-4">Continue Learning</p>
                <p class="text-sm text-gray-300 mb-6 max-w-2xl mx-auto">
                    With the guard rails matching production, Step 11 focuses on navigation polish and session UX.
                </p>
                <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
                    <a href="/admin-dashboard-guide"
                        class="inline-flex items-center gap-2 px-6 py-3 bg-white/10 hover:bg-white/20 rounded-xl transition-colors">
                        <span class="text-lg">‚Üê</span>
                        <span class="text-sm sm:text-base font-semibold">Back to Guide</span>
                    </a>
                    <a href="/admin-dashboard-examples/step9"
                        class="inline-flex items-center gap-2 px-6 py-3 bg-white/10 hover:bg-white/20 rounded-xl transition-colors">
                        <span class="text-lg">‚Üê</span>
                        <span class="text-sm sm:text-base font-semibold">Previous: Step 9</span>
                    </a>
                    <a href="/admin-dashboard-examples/step11"
                        class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-xl transition-colors">
                        <span class="text-sm sm:text-base font-semibold">Next: Step 11</span>
                        <span class="text-lg">‚Üí</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>