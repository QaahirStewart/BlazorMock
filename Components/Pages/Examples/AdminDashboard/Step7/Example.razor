@page "/admin-dashboard-examples/step7"
@rendermode InteractiveServer
@using BlazorMock.Components.Pages.Examples.AdminDashboard.Step7
@inherits ExampleBase

<PageTitle>Admin Dashboard Step 7: Analytics Page - Example</PageTitle>

<div class="min-h-screen py-8 rounded-4xl bg-gray-50">
    <div class="w-full mx-auto px-4 max-w-5xl">
        <!-- Back link -->
        <a href="/admin-dashboard-guide"
            class="inline-flex items-center gap-2 text-sm sm:text-base text-blue-600 hover:text-blue-700 mb-4">
            <span>‚Üê</span> Back to Admin Dashboard Guide
        </a>

        <!-- Title -->
        <h1 class="text-4xl font-bold text-gray-900 mb-4">
            üìä Step 7: Analytics Page (/analytics)
        </h1>

        <!-- Description -->
        <p class="text-xl text-gray-600 mb-8">
            Build the <code>/analytics</code> page to display summary counts and recent activity using the analytics
            events you started recording in Step 6.
        </p>

        <!-- What You'll Learn -->
        <div class="bg-gradient-to-r from-gray-100 to-blue-100 rounded-2xl p-5 sm:p-6 mb-6">
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-4">What You'll Learn</h2>
            <p class="text-gray-700 mb-4 text-sm sm:text-base">
                In this step, you'll query the <code>Activities</code> table to compute summary metrics and display
                recent activity in a simple, readable format.
            </p>
            <ul class="list-disc ml-6 text-sm sm:text-base text-gray-700 space-y-2 mb-4">
                <li>Querying analytics events to compute counts (total users, logins today, etc.).</li>
                <li>Displaying metrics in simple summary cards.</li>
                <li>Showing recent activity in a clean table layout.</li>
                <li>Handling empty states when no events exist yet.</li>
            </ul>
            <div class="mt-2 pt-3 border-t border-blue-200">
                <p class="text-xs sm:text-sm text-gray-700 mb-2">
                    <strong>üí° Key Concepts:</strong> EF Core LINQ aggregates, metrics cards, activity tables, empty
                    states.
                </p>
                <div class="flex flex-wrap items-center gap-2">
                    <span class="text-xs sm:text-sm text-gray-600">‚Üí Related tips:</span>
                    <a href="/tips#tolistasync"
                        class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-[11px] sm:text-xs font-medium hover:bg-blue-200 transition-colors">ToListAsync</a>
                    <a href="/tips#linq-where,-select"
                        class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-[11px] sm:text-xs font-medium hover:bg-blue-200 transition-colors">LINQ
                        (Where, Select)</a>
                    <a href="/tips#setup-ef-core---dbcontext"
                        class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-[11px] sm:text-xs font-medium hover:bg-blue-200 transition-colors">DbContext</a>
                </div>
            </div>
        </div>

        <!-- Sample Analytics Page -->
        <div class="bg-white rounded-xl p-6 border border-gray-200 mb-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">üß© Sample Analytics Page</h2>
            <p class="text-sm text-gray-600 mb-4">
                This example shows a basic <code>/analytics</code> page with summary metrics and a recent activity
                table.
            </p>
            <div class="bg-gray-100 border border-gray-200 rounded-lg p-4 overflow-x-auto mb-4">
                <div class="text-xs text-gray-500 mb-1">Components/Pages/Analytics.razor</div>
                <p class="text-xs text-gray-600 mb-2">Analytics page with summary cards and activity table.</p>
                <ul class="list-disc ml-4 mb-3 text-[11px] text-gray-600 space-y-1">
                    <li>Computes metrics like total users and logins today from the <code>Activities</code> table.</li>
                    <li>Shows recent activity with type, timestamp, and user info.</li>
                    <li>Handles empty states gracefully when no data exists.</li>
                </ul>
                <pre data-code-title="Components/Pages/Analytics.razor"
                    class="code-block text-xs sm:text-sm font-mono text-gray-800 w-full max-w-full overflow-x-auto">@@page "/analytics"
@@using BlazorMock.Data
@@using BlazorMock.Models
@@inject AppDbContext Db

&lt;PageTitle&gt;Analytics&lt;/PageTitle&gt;

&lt;div class="max-w-6xl mx-auto p-6"&gt;
    &lt;h1 class="text-3xl font-bold text-gray-900 mb-6"&gt;Analytics Dashboard&lt;/h1&gt;

    &lt;!-- Summary Cards --&gt;
    &lt;div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8"&gt;
        &lt;div class="bg-white rounded-lg border border-gray-200 p-4"&gt;
            &lt;p class="text-sm text-gray-600 mb-1"&gt;Total Users&lt;/p&gt;
            &lt;p class="text-2xl font-bold text-gray-900"&gt;@@totalUsers&lt;/p&gt;
        &lt;/div&gt;
        &lt;div class="bg-white rounded-lg border border-gray-200 p-4"&gt;
            &lt;p class="text-sm text-gray-600 mb-1"&gt;Logins Today&lt;/p&gt;
            &lt;p class="text-2xl font-bold text-blue-600"&gt;@@loginsToday&lt;/p&gt;
        &lt;/div&gt;
        &lt;div class="bg-white rounded-lg border border-gray-200 p-4"&gt;
            &lt;p class="text-sm text-gray-600 mb-1"&gt;Profile Updates Today&lt;/p&gt;
            &lt;p class="text-2xl font-bold text-green-600"&gt;@@profileUpdatesToday&lt;/p&gt;
        &lt;/div&gt;
        &lt;div class="bg-white rounded-lg border border-gray-200 p-4"&gt;
            &lt;p class="text-sm text-gray-600 mb-1"&gt;Total Events&lt;/p&gt;
            &lt;p class="text-2xl font-bold text-gray-900"&gt;@@totalEvents&lt;/p&gt;
        &lt;/div&gt;
    &lt;/div&gt;

    &lt;!-- Recent Activity Table --&gt;
    &lt;div class="bg-white rounded-lg border border-gray-200 overflow-hidden"&gt;
        &lt;div class="px-6 py-4 border-b border-gray-200"&gt;
            &lt;h2 class="text-xl font-semibold text-gray-900"&gt;Recent Activity&lt;/h2&gt;
        &lt;/div&gt;
        
        @@if (recentActivities.Count == 0)
        {
            &lt;div class="px-6 py-8 text-center text-gray-500"&gt;
                No activity recorded yet. Events will appear here as users sign in and update profiles.
            &lt;/div&gt;
        }
        else
        {
            &lt;div class="overflow-x-auto"&gt;
                &lt;table class="w-full"&gt;
                    &lt;thead class="bg-gray-50"&gt;
                        &lt;tr&gt;
                            &lt;th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"&gt;Type&lt;/th&gt;
                            &lt;th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"&gt;User ID&lt;/th&gt;
                            &lt;th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"&gt;Timestamp&lt;/th&gt;
                        &lt;/tr&gt;
                    &lt;/thead&gt;
                    &lt;tbody class="divide-y divide-gray-200"&gt;
                        @@foreach (var activity in recentActivities)
                        {
                            &lt;tr class="hover:bg-gray-50"&gt;
                                &lt;td class="px-6 py-4 text-sm text-gray-900"&gt;@@activity.Type&lt;/td&gt;
                                &lt;td class="px-6 py-4 text-sm text-gray-600"&gt;@@activity.UserId&lt;/td&gt;
                                &lt;td class="px-6 py-4 text-sm text-gray-600"&gt;@@activity.OccurredAt.ToString("MMM dd, yyyy h:mm tt")&lt;/td&gt;
                            &lt;/tr&gt;
                        }
                    &lt;/tbody&gt;
                &lt;/table&gt;
            &lt;/div&gt;
        }
    &lt;/div&gt;
&lt;/div&gt;

@@code {
    private int totalUsers;
    private int loginsToday;
    private int profileUpdatesToday;
    private int totalEvents;
    private List&lt;Activity&gt; recentActivities = new();

    protected override async Task OnInitializedAsync()
    {
        var today = DateTime.Today;
        var tomorrow = today.AddDays(1);

        // Compute summary metrics
        totalUsers = await Db.Users.CountAsync();
        totalEvents = await Db.Activities.CountAsync();
        
        loginsToday = await Db.Activities
            .Where(a =&gt; a.Type == "UserLogin" &amp;&amp; a.OccurredAt &gt;= today &amp;&amp; a.OccurredAt &lt; tomorrow)
            .CountAsync();
        
        profileUpdatesToday = await Db.Activities
            .Where(a =&gt; a.Type == "ProfileUpdated" &amp;&amp; a.OccurredAt &gt;= today &amp;&amp; a.OccurredAt &lt; tomorrow)
            .CountAsync();

        // Load recent activities (last 20)
        recentActivities = await Db.Activities
            .OrderByDescending(a =&gt; a.OccurredAt)
            .Take(20)
            .ToListAsync();
    }
}</pre>
            </div>

            <!-- Step-by-step breakdown -->
            <h3 class="text-sm font-semibold text-gray-800 mb-2">Step-by-step breakdown</h3>
            <div class="grid gap-4">
                <div class="bg-gray-100 border border-gray-200 rounded-lg p-4">
                    <div class="text-xs text-gray-500 mb-1">1. Compute summary metrics with LINQ aggregates</div>
                    <p class="text-xs text-gray-600 mb-2">Use <code>CountAsync()</code> to get totals and filter by
                        date ranges for today's activity.</p>
                    <ul class="list-disc ml-4 mb-2 text-[11px] text-gray-600 space-y-1">
                        <li>Count all users from the <code>Users</code> table.</li>
                        <li>Filter activities by type and date to get logins and profile updates for today.</li>
                        <li>Store counts in local variables to display in summary cards.</li>
                    </ul>
                    <pre
                        class="code-block text-xs sm:text-sm font-mono text-gray-800 w-full max-w-full overflow-x-auto">var today = DateTime.Today;
var tomorrow = today.AddDays(1);

totalUsers = await Db.Users.CountAsync();
loginsToday = await Db.Activities
    .Where(a =&gt; a.Type == "UserLogin" &amp;&amp; a.OccurredAt &gt;= today &amp;&amp; a.OccurredAt &lt; tomorrow)
    .CountAsync();</pre>
                </div>
                <div class="bg-gray-100 border border-gray-200 rounded-lg p-4">
                    <div class="text-xs text-gray-500 mb-1">2. Load recent activities for the table</div>
                    <p class="text-xs text-gray-600 mb-2">Query the most recent 20 activities ordered by timestamp.
                    </p>
                    <ul class="list-disc ml-4 mb-2 text-[11px] text-gray-600 space-y-1">
                        <li>Use <code>OrderByDescending</code> to get newest events first.</li>
                        <li>Use <code>Take(20)</code> to limit results and keep queries fast.</li>
                        <li>Load into a <code>List&lt;Activity&gt;</code> for easy iteration in the table.</li>
                    </ul>
                    <pre
                        class="code-block text-xs sm:text-sm font-mono text-gray-800 w-full max-w-full overflow-x-auto">recentActivities = await Db.Activities
    .OrderByDescending(a =&gt; a.OccurredAt)
    .Take(20)
    .ToListAsync();</pre>
                </div>
            </div>
        </div>

        <!-- Important Notes & Tips -->
        <div class="bg-white rounded-xl p-6 border border-gray-200 mb-6">
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-4">üìù Important Notes & Tips</h2>
            <div class="space-y-3">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 class="text-sm font-bold text-blue-900 mb-3">üí° Pro Tips</h3>
                    <div class="space-y-4">
                        <div>
                            <p class="text-sm font-semibold text-blue-900 mb-2">Start with simple counts and tables
                            </p>
                            <p class="text-xs text-blue-800">You don't need fancy charts right away. Summary cards and
                                activity tables give users immediate value and are easy to build and maintain.</p>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-blue-900 mb-2">Use date filtering for "today" metrics
                            </p>
                            <p class="text-xs text-blue-800">Filter by <code>DateTime.Today</code> and
                                <code>DateTime.Today.AddDays(1)</code> to get a clean date range for today's activity
                                without time zone issues.
                            </p>
                        </div>
                        <div>
                            <p class="text-sm font-semibold text-blue-900 mb-2">Always handle empty states</p>
                            <p class="text-xs text-blue-800">Show a friendly message when no data exists yet so users
                                understand the page is working‚Äîit just doesn't have events to display.</p>
                        </div>
                    </div>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <h3 class="text-sm font-bold text-yellow-900 mb-2">‚ö†Ô∏è Troubleshooting</h3>
                    <ul class="list-disc ml-6 text-sm text-yellow-900 space-y-1">
                        <li>If metrics show zero but you know there are events, check that your event types match
                            exactly (e.g., <code>"UserLogin"</code> vs <code>"userLogin"</code>).</li>
                        <li>If the table is empty, confirm events are being saved with
                            <code>SaveChangesAsync()</code> after adding them to <code>Db.Activities</code>.
                        </li>
                        <li>If queries are slow, consider adding an index on <code>OccurredAt</code> and
                            <code>Type</code> columns in a future migration.
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- How to do it -->
        <div class="bg-gradient-to-r from-gray-100 to-blue-100 rounded-xl p-6 mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">üõ†Ô∏è How to do it</h2>
            <ol class="list-decimal ml-5 space-y-2 text-gray-700">
                <li>
                    <strong>Create the Analytics page:</strong>
                    Add <code>Components/Pages/Analytics.razor</code> with the <code>@@page "/analytics"</code>
                    directive.
                </li>
                <li>
                    <strong>Inject AppDbContext:</strong>
                    Use <code>@@inject AppDbContext Db</code> so you can query users and activities.
                </li>
                <li>
                    <strong>Compute metrics in OnInitializedAsync:</strong>
                    Use <code>CountAsync()</code> with LINQ filters to calculate total users, logins today, profile
                    updates today, and total events.
                </li>
                <li>
                    <strong>Load recent activities:</strong>
                    Query the last 20 activities ordered by <code>OccurredAt</code> descending.
                </li>
                <li>
                    <strong>Display metrics in cards:</strong>
                    Use a grid layout with simple white cards showing each metric and its count.
                </li>
                <li>
                    <strong>Show activities in a table:</strong>
                    Loop through <code>recentActivities</code> and display type, user ID, and timestamp in table rows.
                </li>
                <li>
                    <strong>Handle empty state:</strong>
                    Show a message when <code>recentActivities.Count == 0</code> so users know the page is working.
                </li>
            </ol>
        </div>

        <!-- Live Demo -->
        <div class="bg-black/3 rounded-2xl p-6 mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">üé¨ Live Demo</h2>
            <p class="text-sm text-gray-600 mb-4">
                Here's a working example of what the analytics dashboard looks like in action:
            </p>
            <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden">
                <!-- Mock Analytics Dashboard -->
                <div class="p-6">
                    <h3 class="text-2xl font-bold text-gray-900 mb-6">Analytics Dashboard</h3>

                    <!-- Summary Cards Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                        <div class="bg-white rounded-lg border border-gray-200 p-4">
                            <p class="text-sm text-gray-600 mb-1">Total Users</p>
                            <p class="text-2xl font-bold text-gray-900">12</p>
                        </div>
                        <div class="bg-white rounded-lg border border-gray-200 p-4">
                            <p class="text-sm text-gray-600 mb-1">Logins Today</p>
                            <p class="text-2xl font-bold text-blue-600">8</p>
                        </div>
                        <div class="bg-white rounded-lg border border-gray-200 p-4">
                            <p class="text-sm text-gray-600 mb-1">Profile Updates Today</p>
                            <p class="text-2xl font-bold text-green-600">3</p>
                        </div>
                        <div class="bg-white rounded-lg border border-gray-200 p-4">
                            <p class="text-sm text-gray-600 mb-1">Total Events</p>
                            <p class="text-2xl font-bold text-gray-900">127</p>
                        </div>
                    </div>

                    <!-- Recent Activity Table -->
                    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                            <h4 class="text-lg font-semibold text-gray-900">Recent Activity</h4>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User
                                            ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                            Timestamp</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 text-sm text-gray-900">UserLogin</td>
                                        <td class="px-6 py-4 text-sm text-gray-600">5</td>
                                        <td class="px-6 py-4 text-sm text-gray-600">Nov 18, 2025 2:45 PM</td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 text-sm text-gray-900">ProfileUpdated</td>
                                        <td class="px-6 py-4 text-sm text-gray-600">3</td>
                                        <td class="px-6 py-4 text-sm text-gray-600">Nov 18, 2025 1:32 PM</td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 text-sm text-gray-900">UserLogin</td>
                                        <td class="px-6 py-4 text-sm text-gray-600">7</td>
                                        <td class="px-6 py-4 text-sm text-gray-600">Nov 18, 2025 12:18 PM</td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 text-sm text-gray-900">UserLogin</td>
                                        <td class="px-6 py-4 text-sm text-gray-600">2</td>
                                        <td class="px-6 py-4 text-sm text-gray-600">Nov 18, 2025 11:05 AM</td>
                                    </tr>
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 text-sm text-gray-900">ProfileUpdated</td>
                                        <td class="px-6 py-4 text-sm text-gray-600">5</td>
                                        <td class="px-6 py-4 text-sm text-gray-600">Nov 18, 2025 10:42 AM</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 border-t border-gray-200 px-6 py-4">
                    <p class="text-xs text-gray-600">
                        üí° <strong>Try it yourself:</strong> Sign in a few times and update your profile, then check
                        back here to see the metrics and activity table update with real data from your database.
                    </p>
                </div>
            </div>
        </div>

        <!-- Mark Complete Section -->
        <div class="bg-white rounded-xl p-6 border-2 border-green-200 mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-1">Finished Step 7?</h3>
                    <p class="text-sm text-gray-600">Mark this step as complete to track your Admin Dashboard learning
                        progress.</p>
                </div>
                @if (isComplete)
                {
                    <div class="flex items-center gap-3">
                        <span class="px-4 py-2 rounded-full bg-green-100 text-green-700 font-medium">‚úì Completed</span>
                        <button @onclick="ResetStep"
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-sm">
                            Reset
                        </button>
                    </div>
                }
                else
                {
                    <button @onclick="MarkComplete"
                        class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">
                        Mark as Complete
                    </button>
                }
            </div>
        </div>

        <!-- Navigation -->
        <div class="mt-8">
            <div class="bg-black/90 rounded-2xl p-6 sm:p-8 text-white text-center">
                <p class="text-lg sm:text-xl font-semibold mb-4">Continue Learning</p>
                <p class="text-sm text-gray-300 mb-6 max-w-2xl mx-auto">
                    With your analytics page displaying metrics and activity, you're ready to add visual elements like
                    bars and heatmaps in Step 8.
                </p>
                <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
                    <a href="/admin-dashboard-guide"
                        class="inline-flex items-center gap-2 px-6 py-3 bg-white/10 hover:bg-white/20 rounded-xl transition-colors">
                        <span class="text-lg">‚Üê</span>
                        <span class="text-sm sm:text-base font-semibold">Back to Guide</span>
                    </a>
                    <a href="/admin-dashboard-examples/step6"
                        class="inline-flex items-center gap-2 px-6 py-3 bg-white/10 hover:bg-white/20 rounded-xl transition-colors">
                        <span class="text-lg">‚Üê</span>
                        <span class="text-sm sm:text-base font-semibold">Previous: Step 6</span>
                    </a>
                    <a href="/admin-dashboard-examples/step8"
                        class="inline-flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-xl transition-colors">
                        <span class="text-sm sm:text-base font-semibold">Next: Step 8</span>
                        <span class="text-lg">‚Üí</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>