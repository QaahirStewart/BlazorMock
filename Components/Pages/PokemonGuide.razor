@page "/pokemon-guide"
@inject ILearningProgressService ProgressService
@inject ILearningGuideService GuideService
@rendermode InteractiveServer

<PageTitle>Pokemon Collector Guide</PageTitle>

<div class="min-h-screen py-8">
    <div class="w-full mx-auto px-4 max-w-5xl">
        <!-- Header Section -->
        <div class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-gray-900 mb-4 break-words">
                üü° Pokemon Collector Guide
            </h1>
        </div>

        <!-- Learning Phases banner -->
        <div class="bg-gradient-to-r from-gray-100 to-blue-100 rounded-2xl p-5 mt-12">
            <h2 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2 break-words">üî∞ Learning Phases</h2>
            <p class="text-sm sm:text-base text-gray-700 break-words">Pick a phase to focus. Each card links to steps
                with examples.</p>
        </div>

        <!-- Phase cards grid -->
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6 my-10 max-w-6xl mx-auto"
            hidden="@(_phases is null || _steps is null)">
            @if (_phases is not null && _steps is not null)
            {
                @foreach (var ph in _phases)
                {
                    var count = _steps.Count(s => s.IsComplete && ph.StepNumbers.Contains(s.StepNumber));
                    <a href="@($"/pokemon-guide/phase/{ph.Id}")"
                        class="rounded-2xl p-0 bg-white border-2 border-gray-200 hover:shadow-lg transition-all text-left block">
                        <div class="p-8">
                            <div class="flex items-start justify-between gap-4 mb-3">
                                <div class="min-w-0">
                                    <div
                                        class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-50 text-blue-700 border border-blue-200 mb-2">
                                        @ph.Subtitle
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-900 mb-1 break-words">@ph.Title</h3>
                                    <p class="text-sm sm:text-base text-gray-700 leading-relaxed break-words">@ph.Description
                                    </p>
                                </div>
                                <div class="text-gray-400 self-start">‚Üí</div>
                            </div>
                            <div class="text-sm text-gray-600">Progress: @count/@ph.StepNumbers.Length</div>
                        </div>
                    </a>
                }
            }
        </div>

        <!-- Learning resources / overall progress -->
        <div class="bg-black/3 rounded-2xl">
            <div class="bg-black/90 rounded-2xl p-5 sm:p-6 text-white">
                <p class="text-lg sm:text-xl font-semibold mb-4 text-center break-words">üìö Learning Resources
                </p>

                <div class="grid sm:grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                    <a href="/progress" class="bg-white/10 hover:bg-white/20 rounded-xl p-4 transition-colors">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl flex-shrink-0">üìä</span>
                            <div class="min-w-0">
                                <div class="text-sm sm:text-base font-semibold break-words">Project Progress</div>
                                <div class="text-xs sm:text-sm text-gray-300 break-words">View all steps & completion
                                </div>
                            </div>
                        </div>
                    </a>
                    <a href="/tips" class="bg-white/10 hover:bg-white/20 rounded-xl p-4 transition-colors">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl flex-shrink-0">üí°</span>
                            <div class="min-w-0">
                                <div class="text-sm sm:text-base font-semibold break-words">Tips System</div>
                                <div class="text-xs sm:text-sm text-gray-300 break-words">Browse Blazor & C# topics
                                </div>
                            </div>
                        </div>
                    </a>
                    <a href="/guide" class="bg-white/10 hover:bg-white/20 rounded-xl p-4 transition-colors">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl flex-shrink-0">üè†</span>
                            <div class="min-w-0">
                                <div class="text-sm sm:text-base font-semibold break-words">All Learning Projects</div>
                                <div class="text-xs sm:text-sm text-gray-300 break-words">Back to the project hub
                                </div>
                            </div>
                        </div>
                    </a>
                </div>

                <div class="text-center text-xs sm:text-sm text-gray-300 break-words" hidden="@(_steps is null)">
                    <strong>Progress:</strong> @_completedCount / @(_steps?.Count ?? 0) steps complete
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private List<StepProgress>? _steps;
    private int _completedCount;
    private IReadOnlyList<Phase>? _phases;

    protected override async Task OnInitializedAsync()
    {
        _steps = await ProgressService.GetAllStepsAsync("pokemon");
        _completedCount = await ProgressService.GetCompletedCountAsync("pokemon");
        _phases = GuideService.GetPhases("pokemon");
    }

    private async Task ToggleStep(int stepNumber)
    {
        if (_steps is null)
        {
            return;
        }

        var step = _steps.FirstOrDefault(s => s.StepNumber == stepNumber);
        if (step is null)
        {
            return;
        }

        if (step.IsComplete)
        {
            await ProgressService.MarkStepIncompleteAsync("pokemon", stepNumber);
        }
        else
        {
            await ProgressService.MarkStepCompleteAsync("pokemon", stepNumber);
        }

        _steps = await ProgressService.GetAllStepsAsync("pokemon");
        _completedCount = await ProgressService.GetCompletedCountAsync("pokemon");
    }
}