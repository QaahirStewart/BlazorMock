@page "/pokemon-guide"
@namespace BlazorMock.Pages
@inject ILearningProgressService ProgressService
@inject ILearningGuideService GuideService
@rendermode InteractiveServer

<PageTitle>Pokemon Collector Guide</PageTitle>

<div class="min-h-screen py-8">
    <div class="w-full mx-auto px-4 max-w-5xl">
        <div class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-gray-900 mb-4 break-words">
                üü° Pokemon Collector Guide
            </h1>
            <p class="text-base sm:text-lg md:text-xl text-gray-600 mb-4 leading-relaxed break-words">
                Learn Blazor fundamentals while building a Pokedex-style collector that talks to a public API.
            </p>
            <p class="text-sm sm:text-base text-gray-500 max-w-2xl mx-auto break-words">
                This guide focuses on HTTP APIs, loading and error states, search and filtering, and client-side state
                patterns.
            </p>
        </div>

        <!-- Progress summary -->
        <div class="rounded-2xl border border-green-200 bg-green-50 p-6 mb-8" hidden="@(_steps is null)">
            <h2 class="text-xl sm:text-2xl font-semibold text-green-900 mb-2 break-words">Your Pokemon Project Progress
            </h2>
            <p class="text-sm sm:text-base text-green-900 mb-2 break-words">
                Progress: @_completedCount / @(_steps?.Count ?? 0) steps complete
            </p>
        </div>

        <div class="rounded-2xl border border-gray-200 bg-white p-6 mb-8">
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-900 mb-3 break-words">What you'll build</h2>
            <p class="text-sm sm:text-base text-gray-700 mb-3 break-words">
                A small Pokemon browser where you can search, page through results, and view basic details pulled from
                an external API
                (such as the public PokeAPI). You'll see how to structure API calls, handle async flows, and keep UI
                responsive.
            </p>
            <ul class="list-disc ml-5 text-sm sm:text-base text-gray-700 space-y-1">
                <li>Call a REST API using <code>HttpClient</code> from Blazor components.</li>
                <li>Show loading and error states instead of blank screens.</li>
                <li>Add search, filters, and simple client-side caching.</li>
                <li>Use components to keep list, detail, and layout concerns separate.</li>
            </ul>
        </div>

        <div class="rounded-2xl border border-blue-200 bg-blue-50 p-6 mb-8">
            <h2 class="text-xl sm:text-2xl font-semibold text-blue-900 mb-3 break-words">Phases & steps</h2>

            @if (_phases is not null && _steps is not null)
            {
                @foreach (var phase in _phases)
                {
                    <div class="mb-5 last:mb-0">
                        <h3 class="text-lg sm:text-xl font-semibold text-blue-900 break-words">@phase.Title</h3>
                        <p class="text-xs sm:text-sm text-blue-900/80 mb-2 break-words">@phase.Subtitle</p>

                        <ul class="space-y-2">
                            @foreach (var stepNumber in phase.StepNumbers)
                            {
                                var step = _steps.FirstOrDefault(s => s.StepNumber == stepNumber);
                                if (step is null)
                                {
                                    continue;
                                }

                                <li class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 bg-white/70 border border-blue-100 rounded-xl px-3 py-2">
                                    <div class="min-w-0">
                                        <div class="text-sm sm:text-base font-medium text-blue-900 break-words">
                                            Step @step.StepNumber: @step.Title
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2 flex-shrink-0">
                                        @if (step.IsComplete)
                                        {
                                            <span class="px-2 py-1 rounded-full bg-green-100 text-green-700 text-xs sm:text-sm font-medium">Done</span>
                                            <button @onclick="() => ToggleStep(step.StepNumber)"
                                                    class="px-2 py-1 text-xs sm:text-sm border border-gray-300 rounded-lg hover:bg-gray-50">
                                                Mark incomplete
                                            </button>
                                        }
                                        else
                                        {
                                            <span class="px-2 py-1 rounded-full bg-gray-100 text-gray-700 text-xs sm:text-sm font-medium">Not started</span>
                                            <button @onclick="() => ToggleStep(step.StepNumber)"
                                                    class="px-2 py-1 text-xs sm:text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                                Mark complete
                                            </button>
                                        }
                                    </div>
                                </li>
                            }
                        </ul>
                    </div>
                }
            }
            else
            {
                <p class="text-sm text-blue-900">Loading steps‚Ä¶</p>
            }
        </div>

        <div class="text-sm text-gray-600 text-center">
            <a href="/guide" class="text-blue-600 hover:text-blue-700 font-medium">‚Üê Back to all learning projects</a>
        </div>
    </div>
</div>

@code {
    private List<StepProgress>? _steps;
    private int _completedCount;
    private IReadOnlyList<Phase>? _phases;

    protected override async Task OnInitializedAsync()
    {
        _steps = await ProgressService.GetAllStepsAsync("pokemon");
        _completedCount = await ProgressService.GetCompletedCountAsync("pokemon");
        _phases = GuideService.GetPhases("pokemon");
    }

    private async Task ToggleStep(int stepNumber)
    {
        if (_steps is null)
        {
            return;
        }

        var step = _steps.FirstOrDefault(s => s.StepNumber == stepNumber);
        if (step is null)
        {
            return;
        }

        if (step.IsComplete)
        {
            await ProgressService.MarkStepIncompleteAsync("pokemon", stepNumber);
        }
        else
        {
            await ProgressService.MarkStepCompleteAsync("pokemon", stepNumber);
        }

        _steps = await ProgressService.GetAllStepsAsync("pokemon");
        _completedCount = await ProgressService.GetCompletedCountAsync("pokemon");
    }
}