@page "/admin/dashboard"
@rendermode InteractiveServer
@inject BlazorMock.Services.IUserAuthService Auth
@inject NavigationManager Nav

<PageTitle>Admin Dashboard</PageTitle>

@if (Auth.CurrentUser?.Role != "Admin")
{
    <div class="py-8 bg-gray-50">
        <div class="max-w-6xl mx-auto px-4">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
                <!-- Left: Access Denied Message -->
                <div class="bg-white rounded-2xl border-2 border-gray-200 p-8 text-center">
                    <div class="h-16 w-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Admin Access Required</h2>
                    <p class="text-gray-600 mb-6">You need admin privileges to access this page.</p>
                    <div class="flex flex-col sm:flex-row gap-3 justify-center">
                        <a href="/signin"
                            class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
                            Sign In
                        </a>
                        <a href="/"
                            class="px-6 py-3 bg-white hover:bg-gray-50 text-gray-700 font-medium border-2 border-gray-200 rounded-lg transition-colors">
                            Go Home
                        </a>
                    </div>
                </div>

                <!-- Right: Demo Accounts -->
                <div class="bg-white rounded-2xl border-2 border-gray-200 p-6 sm:p-8">
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Demo Accounts</h3>
                    <p class="text-sm text-gray-600 mb-6">Click any card to sign in with demo credentials</p>

                    <div class="space-y-3">
                        <!-- Admin Account -->
                        <button @onclick="@(() => SignInAsDemo("admin@demo.com", "admin123"))"
                            class="w-full text-left p-4 bg-red-50 border-2 border-red-200 rounded-xl hover:border-red-400 hover:shadow-lg transition-all duration-200">
                            <div class="flex items-start gap-3">
                                <div
                                    class="h-10 w-10 rounded-full bg-red-600 flex items-center justify-center text-white font-semibold flex-shrink-0">
                                    AD
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <p class="text-sm font-semibold text-gray-900">Admin User</p>
                                        <span
                                            class="px-2 py-0.5 text-xs font-medium bg-red-100 text-red-800 rounded">Admin</span>
                                    </div>
                                    <p class="text-xs text-gray-600 mb-1">admin@demo.com</p>
                                    <p class="text-xs text-gray-500">Full system access • User management</p>
                                </div>
                            </div>
                        </button>

                        <!-- Paid Account -->
                        <button @onclick="@(() => SignInAsDemo("paid@demo.com", "paid123"))"
                            class="w-full text-left p-4 bg-purple-50 border-2 border-purple-200 rounded-xl hover:border-purple-400 hover:shadow-lg transition-all duration-200">
                            <div class="flex items-start gap-3">
                                <div
                                    class="h-10 w-10 rounded-full bg-purple-600 flex items-center justify-center text-white font-semibold flex-shrink-0">
                                    PU
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <p class="text-sm font-semibold text-gray-900">Paid User</p>
                                        <span
                                            class="px-2 py-0.5 text-xs font-medium bg-purple-100 text-purple-800 rounded">Paid</span>
                                    </div>
                                    <p class="text-xs text-gray-600 mb-1">paid@demo.com</p>
                                    <p class="text-xs text-gray-500">Advanced analytics • Premium features</p>
                                </div>
                            </div>
                        </button>

                        <!-- Free Account -->
                        <button @onclick="@(() => SignInAsDemo("user@demo.com", "user123"))"
                            class="w-full text-left p-4 bg-gray-50 border-2 border-gray-200 rounded-xl hover:border-blue-400 hover:shadow-lg transition-all duration-200">
                            <div class="flex items-start gap-3">
                                <div
                                    class="h-10 w-10 rounded-full bg-gray-600 flex items-center justify-center text-white font-semibold flex-shrink-0">
                                    FU
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <p class="text-sm font-semibold text-gray-900">Free User</p>
                                        <span
                                            class="px-2 py-0.5 text-xs font-medium bg-gray-100 text-gray-800 rounded">Free</span>
                                    </div>
                                    <p class="text-xs text-gray-600 mb-1">user@demo.com</p>
                                    <p class="text-xs text-gray-500">Basic metrics • Limited access</p>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="py-8 px-4 bg-gray-50 rounded-3xl">
        <div class="max-w-7xl mx-auto px-4 space-y-6">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-2">Admin Dashboard</h1>
                <p class="text-base text-gray-600">Manage all user accounts and system settings</p>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div
                    class="bg-white rounded-2xl border-2 border-gray-200 p-5 text-center hover:border-blue-400 hover:shadow-lg transition-all duration-200">
                    <p class="text-xs font-medium text-gray-500 uppercase mb-2">Total Users</p>
                    <p class="text-xl font-bold text-gray-900">@Auth.AllUsers.Count</p>
                </div>
                <div
                    class="bg-white rounded-2xl border-2 border-gray-200 p-5 text-center hover:border-blue-400 hover:shadow-lg transition-all duration-200">
                    <p class="text-xs font-medium text-gray-500 uppercase mb-2">Free Users</p>
                    <p class="text-xl font-bold text-gray-900">@Auth.AllUsers.Count(u => u.Role == "Free")</p>
                </div>
                <div
                    class="bg-white rounded-2xl border-2 border-gray-200 p-5 text-center hover:border-blue-400 hover:shadow-lg transition-all duration-200">
                    <p class="text-xs font-medium text-gray-500 uppercase mb-2">Paid Users</p>
                    <p class="text-xl font-bold text-purple-600">@Auth.AllUsers.Count(u => u.Role == "Paid")</p>
                </div>
                <div
                    class="bg-white rounded-2xl border-2 border-gray-200 p-5 text-center hover:border-blue-400 hover:shadow-lg transition-all duration-200">
                    <p class="text-xs font-medium text-gray-500 uppercase mb-2">Admins</p>
                    <p class="text-xl font-bold text-red-600">@Auth.AllUsers.Count(u => u.Role == "Admin")</p>
                </div>
            </div>

            <!-- User Management -->
            <div class="bg-white rounded-2xl border-2 border-gray-200 overflow-hidden">
                <div class="px-4 sm:px-6 py-5 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-900">All Users</h2>
                </div>

                <!-- Mobile View: Cards -->
                <div class="block lg:hidden divide-y divide-gray-200">
                    @foreach (var user in Auth.AllUsers.OrderByDescending(u => u.CreatedAt))
                    {
                        <div class="p-4 hover:bg-gray-50 transition-colors">
                            <div class="flex items-start gap-3 mb-3">
                                @if (!string.IsNullOrEmpty(user.ProfilePictureUrl))
                                {
                                    <img src="@user.ProfilePictureUrl" alt="@user.FullName"
                                        class="h-12 w-12 rounded-full object-cover border-2 border-gray-200 flex-shrink-0" />
                                }
                                else
                                {
                                    <div
                                        class="h-12 w-12 rounded-full bg-white border-2 border-gray-200 flex items-center justify-center flex-shrink-0">
                                        <svg class="w-7 h-7 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                                            <path
                                                d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                                        </svg>
                                    </div>
                                }
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-semibold text-gray-900 truncate">@user.FullName</p>
                                    <p class="text-xs text-gray-500 truncate">@user.Email</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-3 text-xs">
                                <div>
                                    <span class="text-gray-500">Created:</span>
                                    <span class="text-gray-900 font-medium ml-1">@user.CreatedAt.ToString("MMM dd, yyyy")</span>
                                </div>
                                <div>
                                    <span class="text-gray-500">Last Login:</span>
                                    <span class="text-gray-900 font-medium ml-1">@user.LastLoginAt.ToString("MMM dd")</span>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                                <select @onchange="@(e => UpdateUserRole(user.Id, e.Value?.ToString() ?? user.Role))"
                                    class="flex-1 text-sm font-medium px-3 py-2 rounded-lg border-2 border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all @GetRoleClass(user.Role)">
                                    <option value="Free" selected="@(user.Role == "Free")">Free</option>
                                    <option value="Paid" selected="@(user.Role == "Paid")">Paid</option>
                                    <option value="Admin" selected="@(user.Role == "Admin")">Admin</option>
                                </select>
                                @if (user.Id != Auth.CurrentUser.Id)
                                {
                                    <button @onclick="() => DeleteUser(user.Id)"
                                        class="w-full sm:w-auto px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg transition-colors">
                                        Delete
                                    </button>
                                }
                                else
                                {
                                    <span
                                        class="w-full sm:w-auto text-center px-4 py-2 text-xs font-medium text-gray-500 bg-gray-100 rounded-lg">You</span>
                                }
                            </div>
                        </div>
                    }
                </div>

                <!-- Desktop View: Table -->
                <div class="hidden lg:block overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Login</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            @foreach (var user in Auth.AllUsers.OrderByDescending(u => u.CreatedAt))
                            {
                                <tr class="hover:bg-gray-50 transition-colors">
                                    <td class="px-6 py-4">
                                        <div class="flex items-center gap-3">
                                            @if (!string.IsNullOrEmpty(user.ProfilePictureUrl))
                                            {
                                                <img src="@user.ProfilePictureUrl" alt="@user.FullName"
                                                    class="h-10 w-10 rounded-full object-cover border-2 border-gray-200" />
                                            }
                                            else
                                            {
                                                <div
                                                    class="h-10 w-10 rounded-full bg-white border-2 border-gray-200 flex items-center justify-center">
                                                    <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                                                        <path
                                                            d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                                                    </svg>
                                                </div>
                                            }
                                            <span class="text-sm font-medium text-gray-900">@user.FullName</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-600">@user.Email</td>
                                    <td class="px-6 py-4">
                                        <select @onchange="@(e => UpdateUserRole(user.Id, e.Value?.ToString() ?? user.Role))"
                                            class="text-sm font-medium px-3 py-1.5 rounded-lg border-2 border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all @GetRoleClass(user.Role)">
                                            <option value="Free" selected="@(user.Role == "Free")">Free</option>
                                            <option value="Paid" selected="@(user.Role == "Paid")">Paid</option>
                                            <option value="Admin" selected="@(user.Role == "Admin")">Admin</option>
                                        </select>
                                    </td>
                                    <td class="px-6 py-4 text-sm text-gray-600">@user.CreatedAt.ToString("MMM dd, yyyy")</td>
                                    <td class="px-6 py-4 text-sm text-gray-600">@user.LastLoginAt.ToString("MMM dd, h:mm tt")
                                    </td>
                                    <td class="px-6 py-4 text-right">
                                        @if (user.Id != Auth.CurrentUser.Id)
                                        {
                                            <button @onclick="() => DeleteUser(user.Id)"
                                                class="px-3 py-1.5 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg transition-colors">
                                                Delete
                                            </button>
                                        }
                                        else
                                        {
                                            <span
                                                class="text-xs font-medium text-gray-500 bg-gray-100 px-3 py-1.5 rounded-lg">You</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool isQuickMenuOpen;

    private string GetUserInitials()
    {
        if (Auth.CurrentUser == null) return "?";
        var parts = Auth.CurrentUser.FullName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2) return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return Auth.CurrentUser.FullName[0].ToString().ToUpper();
    }

    private string GetUserAvatarColor()
    {
        if (Auth.CurrentUser == null) return "bg-gray-500";
        return Auth.CurrentUser.Role switch
        {
            "Admin" => "bg-red-600",
            "Paid" => "bg-purple-600",
            _ => "bg-blue-600"
        };
    }

    private void ToggleQuickMenu()
    {
        isQuickMenuOpen = !isQuickMenuOpen;
    }

    private void HandleSignOut()
    {
        Auth.SignOut();
        isQuickMenuOpen = false;
        Nav.NavigateTo("/signin");
    }

    private string GetInitials(string name)
    {
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2) return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return name[0].ToString().ToUpper();
    }

    private string GetAvatarColor(string name)
    {
        var hash = Math.Abs(name.GetHashCode());
        var colors = new[] { "bg-blue-500", "bg-purple-500", "bg-emerald-500", "bg-orange-500", "bg-pink-500", "bg-indigo-500" };
        return colors[hash % colors.Length];
    }

    private string GetRoleClass(string role)
    {
        return role switch
        {
            "Admin" => "bg-red-50 text-red-700 hover:bg-red-100",
            "Paid" => "bg-purple-50 text-purple-700 hover:bg-purple-100",
            _ => "bg-gray-50 text-gray-700 hover:bg-gray-100"
        };
    }

    private void UpdateUserRole(int userId, string newRole)
    {
        Auth.AdminUpdateUserRole(userId, newRole);
        StateHasChanged();
    }

    private void DeleteUser(int userId)
    {
        Auth.AdminDeleteUser(userId);
        StateHasChanged();
    }

    private void SignInAsDemo(string email, string password)
    {
        var success = Auth.SignIn(email, password);
        if (success)
        {
            Nav.NavigateTo("/admin/dashboard", forceLoad: true);
        }
    }
}